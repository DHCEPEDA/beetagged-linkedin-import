<!-- BeeTagged Positioned Widget with Working Dual CSV Upload -->
<!-- Copy this code into: Settings > Advanced > Code Injection > HEADER -->

<div id="beetagged-widget-container"></div>

<script>
window.addEventListener('load', function() {
  const BACKEND_URL = 'https://beetagged-app-53414697acd3.herokuapp.com';
  
  // Create the full widget HTML with positioned layout and working dual import
  const widgetHTML = `
    <div style="
      padding: 4rem 2rem 2rem 2rem;
      box-sizing: border-box;
    ">
      <!-- Header Section -->
      <div style="
        text-align: center;
        margin-bottom: 4rem;
      ">
        <h1 style="
          font-size: 3rem; 
          font-weight: 700; 
          margin: 0 0 1rem 0;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          background-clip: text;
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        ">üè∑Ô∏è BeeTagged</h1>
        <p style="
          font-size: 1.2rem; 
          color: #6b7280; 
          margin: 0;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        ">AI-Powered Contact Intelligence & Professional Network Search</p>
      </div>
      
      <!-- Main Widget Container -->
      <div style="
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
        background: #87CEEB;
        border-radius: 16px;
        color: #00A86B;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      ">
        
        <div style="display: flex; background: rgba(255,255,255,0.3); border-radius: 12px; padding: 4px; margin-bottom: 2rem;">
          <button id="search-tab" style="flex: 1; padding: 12px 16px; border: none; background: rgba(255,255,255,0.5); color: #00A86B; cursor: pointer; border-radius: 8px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s ease;">üîç Search Contacts</button>
          <button id="import-tab" style="flex: 1; padding: 12px 16px; border: none; background: transparent; color: #00A86B; cursor: pointer; border-radius: 8px; font-weight: 500; transition: all 0.3s ease;">üìÅ Import LinkedIn</button>
        </div>
        
        <!-- Search Tab Content -->
        <div id="search-content" style="display: block;">
          <div style="background: rgba(255,255,255,0.3); padding: 2rem; border-radius: 12px; margin-bottom: 1rem;">
            <input type="text" id="search-input" placeholder="Search your contacts naturally: 'people who work at tech companies in San Francisco'" style="
              width: 100%;
              padding: 12px 16px;
              border: none;
              border-radius: 8px;
              font-size: 1rem;
              margin-bottom: 1rem;
              background: rgba(255,255,255,0.9);
              color: #333;
              box-sizing: border-box;
            ">
            
            <button id="search-btn" style="
              width: 100%;
              padding: 12px 24px;
              border: none;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              background: rgba(255,255,255,0.5);
              color: #00A86B;
              border: 2px solid rgba(255,255,255,0.5);
              transition: all 0.3s ease;
            ">Search Contacts</button>
            
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 1rem; justify-content: center;">
              <span class="example-tag" data-query="Michael" style="background: rgba(255,255,255,0.5); color: #00A86B; padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.5);">Find Michael</span>
              <span class="example-tag" data-query="people who work at tech companies" style="background: rgba(255,255,255,0.5); color: #00A86B; padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.5);">Tech workers</span>
              <span class="example-tag" data-query="contacts in San Francisco" style="background: rgba(255,255,255,0.5); color: #00A86B; padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.5);">San Francisco</span>
            </div>
          </div>
          
          <div id="search-results" style="
            background: rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
            display: none;
          ">
            <h3 style="margin: 0 0 1rem 0; text-align: center;">Search Results</h3>
            <div id="results-list"></div>
          </div>
        </div>
        
        <!-- Import Tab Content -->
        <div id="import-content" style="display: none;">
          <div style="background: rgba(255,255,255,0.3); padding: 2rem; border-radius: 12px;">
            <h3 style="margin: 0 0 1.5rem 0; text-align: center;">üìÅ LinkedIn CSV Import</h3>
            
            <!-- Simplified Upload Instructions -->
            <div style="text-align: center; margin-bottom: 2rem;">
              <p style="margin: 0 0 1rem 0; opacity: 0.9;">Upload your LinkedIn export CSV files:</p>
              <p style="margin: 0; font-size: 0.9rem; opacity: 0.8;">You can upload Contacts CSV and/or Connections CSV</p>
            </div>
            
            <!-- File Upload Areas -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
              <div id="contacts-zone" style="
                border: 2px dashed rgba(255,255,255,0.5);
                border-radius: 12px;
                padding: 1.5rem;
                text-align: center;
                cursor: pointer;
                background: rgba(255,255,255,0.3);
                transition: all 0.3s ease;
              ">
                <h4 style="margin: 0 0 0.5rem 0; color: #00A86B;">üìã Contacts CSV</h4>
                <p style="font-size: 0.9rem; margin: 0 0 0.5rem 0; color: #00A86B;">Detailed contact info</p>
                <div id="contacts-status" style="font-size: 0.8rem; opacity: 0.7; color: #00A86B;">Click to upload</div>
                <input type="file" id="contacts-input" accept=".csv" style="display: none;">
              </div>
              
              <div id="connections-zone" style="
                border: 2px dashed rgba(255,255,255,0.5);
                border-radius: 12px;
                padding: 1.5rem;
                text-align: center;
                cursor: pointer;
                background: rgba(255,255,255,0.3);
                transition: all 0.3s ease;
              ">
                <h4 style="margin: 0 0 0.5rem 0; color: #00A86B;">üîó Connections CSV</h4>
                <p style="font-size: 0.9rem; margin: 0 0 0.5rem 0; color: #00A86B;">Network connections</p>
                <div id="connections-status" style="font-size: 0.8rem; opacity: 0.7; color: #00A86B;">Click to upload</div>
                <input type="file" id="connections-input" accept=".csv" style="display: none;">
              </div>
            </div>
            
            <div id="upload-status" style="display: none;"></div>
            
            <div style="margin-top: 1rem;">
              <h4 style="margin: 0 0 0.5rem 0; text-align: center;">üìã How to export from LinkedIn:</h4>
              <ol style="font-size: 0.9rem; opacity: 0.9; padding-left: 1.2rem; margin: 0; max-width: 600px; margin: 0 auto;">
                <li>Go to LinkedIn Settings & Privacy</li>
                <li>Click "Data Privacy" ‚Üí "Get a copy of your data"</li>
                <li>Select both "Connections" and "Contacts"</li>
                <li>Upload the CSV files here (either one or both)</li>
              </ol>
            </div>
          </div>
        </div>
        
        <div id="global-message" style="display: none;"></div>
      </div>
    </div>
    
    <!-- Baseball Card Modal -->
    <div id="baseball-card-modal" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      padding: 2rem;
      box-sizing: border-box;
      overflow-y: auto;
    ">
      <div style="
        max-width: 500px;
        margin: 0 auto;
        background: #87CEEB;
        border-radius: 20px;
        color: #00A86B;
        box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        position: relative;
      ">
        <button id="close-modal" style="
          position: absolute;
          top: 1rem;
          right: 1rem;
          background: rgba(255,255,255,0.5);
          border: none;
          color: #00A86B;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          cursor: pointer;
          font-size: 1.2rem;
          transition: all 0.3s ease;
        ">√ó</button>
        
        <div id="baseball-card-content"></div>
      </div>
    </div>
  `;
  
  // Inject the widget into the page
  const container = document.getElementById('beetagged-widget-container');
  if (container) {
    container.innerHTML = widgetHTML;
    initializeWidget();
  }
  
  function initializeWidget() {
    setupTabs();
    setupSearch();
    setupFileUpload();
    setupModals();
  }
  
  function setupTabs() {
    const searchTab = document.getElementById('search-tab');
    const importTab = document.getElementById('import-tab');
    const searchContent = document.getElementById('search-content');
    const importContent = document.getElementById('import-content');
    
    if (searchTab && importTab && searchContent && importContent) {
      searchTab.onclick = function() {
        searchTab.style.background = 'rgba(255,255,255,0.5)';
        searchTab.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        importTab.style.background = 'transparent';
        importTab.style.boxShadow = 'none';
        searchContent.style.display = 'block';
        importContent.style.display = 'none';
      };
      
      importTab.onclick = function() {
        importTab.style.background = 'rgba(255,255,255,0.5)';
        importTab.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        searchTab.style.background = 'transparent';
        searchTab.style.boxShadow = 'none';
        importContent.style.display = 'block';
        searchContent.style.display = 'none';
      };
    }
  }
  
  function setupSearch() {
    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');
    const exampleTags = document.querySelectorAll('.example-tag');
    
    if (searchBtn && searchInput) {
      searchBtn.onclick = performSearch;
      searchInput.onkeypress = function(e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      };
    }
    
    exampleTags.forEach(function(tag) {
      tag.onclick = function() {
        if (searchInput) {
          searchInput.value = tag.dataset.query;
          performSearch();
        }
      };
    });
  }
  
  async function performSearch() {
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const resultsContainer = document.getElementById('search-results');
    const resultsList = document.getElementById('results-list');
    
    if (!searchInput || !searchInput.value.trim()) {
      showMessage('Please enter a search query.', 'error');
      return;
    }
    
    const query = searchInput.value.trim();
    
    if (searchBtn) {
      searchBtn.disabled = true;
      searchBtn.textContent = 'Searching...';
    }
    
    try {
      const response = await fetch(BACKEND_URL + '/api/search/natural?q=' + encodeURIComponent(query));
      
      if (!response.ok) {
        throw new Error('Search failed');
      }
      
      const data = await response.json();
      
      if (resultsList && resultsContainer) {
        if (data.results && data.results.length > 0) {
          var resultsHTML = '';
          for (var i = 0; i < data.results.length; i++) {
            var contact = data.results[i];
            resultsHTML += '<div style="background: rgba(255,255,255,0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.5); cursor: pointer; transition: all 0.3s ease;" onclick="showBaseballCard(' + JSON.stringify(contact).replace(/"/g, '&quot;') + ')">';
            resultsHTML += '<div style="font-weight: 600; margin-bottom: 0.5rem;">' + contact.name + '</div>';
            resultsHTML += '<div style="opacity: 0.8; font-size: 0.9rem;">';
            if (contact.company) resultsHTML += contact.company + ' ‚Ä¢ ';
            if (contact.position) resultsHTML += contact.position;
            if (contact.location) resultsHTML += ' ‚Ä¢ ' + contact.location;
            resultsHTML += '</div>';
            if (contact.tags && contact.tags.length > 0) {
              resultsHTML += '<div style="margin-top: 0.5rem;">';
              for (var j = 0; j < contact.tags.length; j++) {
                resultsHTML += '<span style="background: rgba(255,255,255,0.5); color: #00A86B; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin-right: 4px;">' + contact.tags[j] + '</span>';
              }
              resultsHTML += '</div>';
            }
            resultsHTML += '</div>';
          }
          resultsList.innerHTML = resultsHTML;
          resultsContainer.style.display = 'block';
        } else {
          resultsList.innerHTML = '<p style="text-align: center; opacity: 0.8;">No contacts found matching your search.</p>';
          resultsContainer.style.display = 'block';
        }
      }
      
    } catch (error) {
      showMessage('Search failed. Please try again.', 'error');
    } finally {
      if (searchBtn) {
        searchBtn.disabled = false;
        searchBtn.textContent = 'Search Contacts';
      }
    }
  }
  
  function setupFileUpload() {
    const contactsZone = document.getElementById('contacts-zone');
    const contactsInput = document.getElementById('contacts-input');
    const connectionsZone = document.getElementById('connections-zone');
    const connectionsInput = document.getElementById('connections-input');
    
    // Contacts file upload
    if (contactsZone && contactsInput) {
      contactsZone.onclick = function() { contactsInput.click(); };
      contactsInput.onchange = function(e) {
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files[0], 'contacts');
        }
      };
    }
    
    // Connections file upload  
    if (connectionsZone && connectionsInput) {
      connectionsZone.onclick = function() { connectionsInput.click(); };
      connectionsInput.onchange = function(e) {
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files[0], 'connections');
        }
      };
    }
  }
  
  async function handleFileUpload(file, type) {
    if (!file.name.endsWith('.csv')) {
      showMessage('Please select a CSV file.', 'error');
      return;
    }
    
    const statusDiv = document.getElementById(type + '-status');
    const uploadStatus = document.getElementById('upload-status');
    
    if (statusDiv) {
      statusDiv.textContent = 'Uploading...';
      statusDiv.style.color = '#fbbf24';
    }
    
    if (uploadStatus) {
      uploadStatus.style.display = 'block';
      uploadStatus.innerHTML = '<div style="text-align: center; padding: 1rem; color: #00A86B;">Uploading ' + type + ' file: ' + file.name + '</div>';
    }
    
    try {
      console.log('Starting upload for file:', file.name, 'Type:', type);
      
      const formData = new FormData();
      formData.append('linkedinCsv', file);
      
      console.log('Sending request to:', BACKEND_URL + '/api/import/linkedin');
      
      const response = await fetch(BACKEND_URL + '/api/import/linkedin', {
        method: 'POST',
        body: formData,
        mode: 'cors',
        credentials: 'omit'
      });
      
      console.log('Response status:', response.status);
      console.log('Response headers:', response.headers);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('Upload failed with status:', response.status, 'Error:', errorText);
        throw new Error('Upload failed with status: ' + response.status);
      }
      
      const data = await response.json();
      console.log('Upload response data:', data);
      
      if (statusDiv) {
        statusDiv.textContent = '‚úì ' + file.name;
        statusDiv.style.color = '#10b981';
      }
      
      var message = 'Successfully processed ' + type + ' file!';
      if (data.count && data.count > 0) {
        message += ' Added ' + data.count + ' new contacts.';
      }
      if (data.enhanced && data.enhanced > 0) {
        message += ' Enhanced ' + data.enhanced + ' existing contacts.';
      }
      if (data.processed) {
        message += ' Processed ' + data.processed + ' records total.';
      }
      
      showMessage(message, 'success');
      
    } catch (error) {
      console.error('Upload error details:', error);
      
      if (statusDiv) {
        statusDiv.textContent = '‚úó Upload failed';
        statusDiv.style.color = '#ef4444';
      }
      
      var errorMessage = 'Upload failed for ' + type + ' file: ' + error.message;
      if (error.name === 'TypeError' && error.message.includes('fetch')) {
        errorMessage += ' (Network connection issue - please check your internet connection)';
      }
      
      showMessage(errorMessage, 'error');
    } finally {
      if (uploadStatus) {
        setTimeout(function() {
          uploadStatus.style.display = 'none';
        }, 2000);
      }
    }
  }
  
  function setupModals() {
    const cardModal = document.getElementById('baseball-card-modal');
    const closeModal = document.getElementById('close-modal');
    
    if (closeModal && cardModal) {
      closeModal.onclick = function() { cardModal.style.display = 'none'; };
      cardModal.onclick = function(e) {
        if (e.target === cardModal) cardModal.style.display = 'none';
      };
    }
  }
  
  function showBaseballCard(contact) {
    const modal = document.getElementById('baseball-card-modal');
    const content = document.getElementById('baseball-card-content');
    
    if (!modal || !content) return;
    
    var cardHTML = '<div style="padding: 2rem;">';
    cardHTML += '<div style="text-align: center; margin-bottom: 2rem;">';
    cardHTML += '<div style="width: 120px; height: 120px; border-radius: 50%; background: rgba(255,255,255,0.5); margin: 0 auto 1rem auto; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #00A86B;">';
    cardHTML += contact.name ? contact.name.charAt(0).toUpperCase() : 'üë§';
    cardHTML += '</div>';
    cardHTML += '<h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">' + contact.name + '</h2>';
    cardHTML += '<p style="margin: 0; opacity: 0.8;">' + (contact.position || 'Professional Contact') + '</p>';
    cardHTML += '</div>';
    cardHTML += '<div style="background: rgba(255,255,255,0.3); border-radius: 12px; padding: 1.5rem;">';
    if (contact.company) cardHTML += '<div style="margin-bottom: 1rem;"><strong>Company:</strong> ' + contact.company + '</div>';
    if (contact.email) cardHTML += '<div style="margin-bottom: 1rem;"><strong>Email:</strong> ' + contact.email + '</div>';
    if (contact.phone) cardHTML += '<div style="margin-bottom: 1rem;"><strong>Phone:</strong> ' + contact.phone + '</div>';
    if (contact.location) cardHTML += '<div style="margin-bottom: 1rem;"><strong>Location:</strong> ' + contact.location + '</div>';
    cardHTML += '</div>';
    if (contact.tags && contact.tags.length > 0) {
      cardHTML += '<div style="margin-top: 1.5rem;">';
      cardHTML += '<h4 style="margin: 0 0 0.5rem 0;">Tags:</h4>';
      cardHTML += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
      for (var i = 0; i < contact.tags.length; i++) {
        cardHTML += '<span style="background: rgba(255,255,255,0.5); color: #00A86B; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;">' + contact.tags[i] + '</span>';
      }
      cardHTML += '</div>';
      cardHTML += '</div>';
    }
    cardHTML += '</div>';
    
    content.innerHTML = cardHTML;
    modal.style.display = 'block';
  }
  
  function showMessage(message, type) {
    const messageContainer = document.getElementById('global-message');
    if (!messageContainer) return;
    
    const bgColor = type === 'success' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
    const borderColor = type === 'success' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)';
    const textColor = '#00A86B';
    
    messageContainer.innerHTML = '<div style="background: ' + bgColor + '; border: 1px solid ' + borderColor + '; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: center; color: ' + textColor + '; font-weight: 500;">' + message + '</div>';
    messageContainer.style.display = 'block';
    
    // Scroll to message
    messageContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    setTimeout(function() {
      messageContainer.style.display = 'none';
    }, 8000);
  }
});
</script>