<!-- BeeTagged Final Production Widget - CSV Upload Fixed -->
<!-- Copy this code into: Settings > Advanced > Code Injection > HEADER -->

<div id="beetagged-widget-container"></div>

<script>
window.addEventListener('load', function() {
  const BACKEND_URL = 'https://beetagged-app-53414697acd3.herokuapp.com';
  const FACEBOOK_APP_ID = '1222790436230433';
  
  // Service status monitoring
  let backendStatus = 'unknown';
  
  // Load Facebook SDK
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));

  window.fbAsyncInit = function() {
    FB.init({
      appId: FACEBOOK_APP_ID,
      cookie: true,
      xfbml: true,
      version: 'v18.0'
    });
  };
  
  const widgetHTML = `
    <div style="
      position: relative;
      width: 100%;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
      box-sizing: border-box;
    ">
      <div style="
        max-width: 800px;
        width: 100%;
        padding: 2rem;
        background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 100%);
        border-radius: 16px;
        color: #2c3e50;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        margin: auto;
      ">
        <div style="text-align: center; margin-bottom: 2rem;">
          <h1 style="font-size: 2.5rem; font-weight: 700; margin: 0 0 0.5rem 0; background: linear-gradient(45deg, #00A86B, #2ecc71); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üêù BeeTagged</h1>
          <p style="font-size: 1.1rem; opacity: 0.9; margin: 0;">AI-Powered Contact Intelligence & Search</p>
          <div id="service-status" style="margin-top: 0.5rem; font-size: 0.8rem; padding: 4px 8px; border-radius: 12px; display: inline-block; background: rgba(243, 156, 18, 0.1); color: #f39c12;">üîÑ Checking service status...</div>
        </div>
        
        <div style="display: flex; background: rgba(255,255,255,0.3); border-radius: 12px; padding: 4px; margin-bottom: 2rem;">
          <button id="search-tab" style="flex: 1; padding: 12px 16px; border: none; background: rgba(255,255,255,0.8); color: #2c3e50; cursor: pointer; border-radius: 8px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">Search Contacts</button>
          <button id="import-tab" style="flex: 1; padding: 12px 16px; border: none; background: transparent; color: #2c3e50; cursor: pointer; border-radius: 8px; font-weight: 500;">Import & Connect</button>
        </div>
        
        <!-- Search Tab Content -->
        <div id="search-content" style="display: block;">
          <div style="background: rgba(255,255,255,0.8); padding: 2rem; border-radius: 12px; margin-bottom: 1rem;">
            <input type="text" id="search-input" placeholder="Search your contacts naturally: 'engineers at Google'" style="
              width: 100%;
              padding: 12px 16px;
              border: 2px solid rgba(0, 168, 107, 0.2);
              border-radius: 8px;
              font-size: 1rem;
              margin-bottom: 1rem;
              background: white;
              color: #333;
              box-sizing: border-box;
            ">
            
            <button id="search-btn" style="
              width: 100%;
              padding: 12px 24px;
              border: none;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              background: linear-gradient(45deg, #00A86B, #2ecc71);
              color: white;
              transition: all 0.3s ease;
            ">Search Contacts</button>
            
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 1rem; justify-content: center;">
              <span class="example-tag" data-query="engineers at Google" style="background: rgba(0, 168, 107, 0.1); padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(0, 168, 107, 0.3); color: #00A86B;">Engineers at Google</span>
              <span class="example-tag" data-query="people in San Francisco" style="background: rgba(0, 168, 107, 0.1); padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(0, 168, 107, 0.3); color: #00A86B;">San Francisco</span>
              <span class="example-tag" data-query="marketing directors" style="background: rgba(0, 168, 107, 0.1); padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(0, 168, 107, 0.3); color: #00A86B;">Marketing Directors</span>
            </div>
          </div>
          
          <div id="search-results" style="
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
            display: none;
          ">
            <h3 style="margin: 0 0 1rem 0; text-align: center; color: #2c3e50;">Search Results</h3>
            <div id="results-list"></div>
          </div>
        </div>
        
        <!-- Import Tab Content -->
        <div id="import-content" style="display: none;">
          <div style="background: rgba(255,255,255,0.8); padding: 2rem; border-radius: 12px;">
            
            <!-- Facebook Import Section -->
            <div style="margin-bottom: 2rem; border-bottom: 1px solid rgba(0, 168, 107, 0.2); padding-bottom: 2rem;">
              <h3 style="margin: 0 0 1rem 0; color: #2c3e50; display: flex; align-items: center; gap: 0.5rem;">
                üìò Facebook Import
                <span id="facebook-status" style="font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; background: rgba(231, 76, 60, 0.1); color: #e74c3c;">‚≠ï Disconnected</span>
              </h3>
              
              <div id="facebook-section">
                <div id="facebook-connect" style="display: block;">
                  <button id="facebook-connect-btn" style="
                    width: 100%;
                    padding: 12px 24px;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    background: #1877F2;
                    color: white;
                    font-size: 1rem;
                    margin-bottom: 1rem;
                    transition: all 0.3s ease;
                  ">Connect Facebook Account</button>
                  <p style="font-size: 0.9rem; opacity: 0.8; margin: 0; text-align: center; color: #2c3e50;">Connect your Facebook account to import your profile and friends</p>
                </div>
                
                <div id="facebook-connected" style="display: none;">
                  <div style="background: rgba(0, 168, 107, 0.1); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; text-align: center;">
                    <div id="facebook-profile" style="margin-bottom: 1rem; color: #2c3e50;"></div>
                    <button id="facebook-import-btn" style="
                      padding: 8px 16px;
                      border: none;
                      border-radius: 6px;
                      background: linear-gradient(45deg, #00A86B, #2ecc71);
                      color: white;
                      cursor: pointer;
                      margin-right: 8px;
                      font-weight: 500;
                    ">Import Contacts</button>
                    <button id="facebook-disconnect-btn" style="
                      padding: 8px 16px;
                      border: none;
                      border-radius: 6px;
                      background: rgba(220, 38, 38, 0.2);
                      color: #dc2626;
                      cursor: pointer;
                      font-weight: 500;
                    ">Disconnect</button>
                  </div>
                  <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 1rem; font-size: 0.85rem; color: #2c3e50;">
                    <strong>Note:</strong> Facebook only allows apps to access friends who have also authorized the same app. You may see limited results due to Facebook's privacy policies.
                  </div>
                </div>
              </div>
            </div>
            
            <!-- LinkedIn Import Section -->
            <div>
              <h3 style="margin: 0 0 1rem 0; color: #2c3e50;">üíº LinkedIn Import</h3>
              <div id="upload-zone" style="
                border: 2px dashed rgba(0, 168, 107, 0.3);
                border-radius: 12px;
                padding: 2rem;
                text-align: center;
                cursor: pointer;
                background: rgba(0, 168, 107, 0.05);
                margin-bottom: 1rem;
                transition: all 0.3s ease;
              ">
                <h4 style="margin: 0 0 1rem 0; color: #2c3e50;">üìÅ Upload LinkedIn CSV</h4>
                <p style="margin: 0 0 0.5rem 0; color: #2c3e50;">Export your LinkedIn connections and upload the CSV file here</p>
                <p style="font-size: 0.9rem; opacity: 0.8; margin: 0; color: #2c3e50;">Drag & drop or click to select</p>
                <input type="file" id="file-input" accept=".csv" style="display: none;">
              </div>
              
              <div id="upload-status" style="display: none;"></div>
              
              <div style="margin-top: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">üìã How to export from LinkedIn:</h4>
                <ol style="font-size: 0.9rem; color: #2c3e50; padding-left: 1.2rem; margin: 0;">
                  <li>Go to LinkedIn Settings & Privacy</li>
                  <li>Click "Data Privacy" ‚Üí "Get a copy of your data"</li>
                  <li>Select "Connections" and download</li>
                  <li>Upload the CSV file here</li>
                </ol>
              </div>
            </div>
          </div>
        </div>
        
        <div id="global-message" style="display: none;"></div>
      </div>
    </div>
  `;
  
  // Insert widget into container
  const container = document.getElementById('beetagged-widget-container');
  if (container) {
    container.innerHTML = widgetHTML;
    setupWidget();
  }
  
  let facebookAccessToken = null;
  let facebookProfile = null;
  
  // Service status monitoring
  async function checkServiceStatus() {
    const statusElement = document.getElementById('service-status');
    if (!statusElement) return;
    
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      
      const response = await fetch(`${BACKEND_URL}/`, {
        method: 'GET',
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (response.ok) {
        backendStatus = 'online';
        statusElement.style.background = 'rgba(39, 174, 96, 0.1)';
        statusElement.style.color = '#27ae60';
        statusElement.textContent = '‚úÖ Service Online';
      } else {
        throw new Error('Service unavailable');
      }
    } catch (error) {
      backendStatus = 'offline';
      statusElement.style.background = 'rgba(231, 76, 60, 0.1)';
      statusElement.style.color = '#e74c3c';
      statusElement.textContent = '‚ùå Service Offline';
    }
  }
  
  function updateFacebookStatus(status, text) {
    const statusElement = document.getElementById('facebook-status');
    if (statusElement) {
      let bgColor, textColor, icon;
      switch(status) {
        case 'connected':
          bgColor = 'rgba(39, 174, 96, 0.1)';
          textColor = '#27ae60';
          icon = '‚úÖ';
          break;
        case 'connecting':
          bgColor = 'rgba(243, 156, 18, 0.1)';
          textColor = '#f39c12';
          icon = 'üîÑ';
          break;
        default:
          bgColor = 'rgba(231, 76, 60, 0.1)';
          textColor = '#e74c3c';
          icon = '‚≠ï';
      }
      statusElement.style.background = bgColor;
      statusElement.style.color = textColor;
      statusElement.textContent = `${icon} ${text}`;
    }
  }
  
  function setupWidget() {
    // Check service status
    checkServiceStatus();
    setInterval(checkServiceStatus, 30000);
    
    // Tab switching
    const searchTab = document.getElementById('search-tab');
    const importTab = document.getElementById('import-tab');
    const searchContent = document.getElementById('search-content');
    const importContent = document.getElementById('import-content');
    
    searchTab.onclick = function() {
      searchTab.style.background = 'rgba(255,255,255,0.8)';
      importTab.style.background = 'transparent';
      searchContent.style.display = 'block';
      importContent.style.display = 'none';
    };
    
    importTab.onclick = function() {
      importTab.style.background = 'rgba(255,255,255,0.8)';
      searchTab.style.background = 'transparent';
      importContent.style.display = 'block';
      searchContent.style.display = 'none';
    };
    
    // Search functionality
    document.getElementById('search-btn').onclick = performSearch;
    document.getElementById('search-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') performSearch();
    });
    
    // Example tag clicks
    document.querySelectorAll('.example-tag').forEach(tag => {
      tag.onclick = function() {
        document.getElementById('search-input').value = this.getAttribute('data-query');
        performSearch();
      };
    });
    
    // File upload setup
    setupFileUpload();
    
    // Facebook setup
    setupFacebookFeatures();
    
    // Load sample contacts
    loadSampleContacts();
  }
  
  function setupFacebookFeatures() {
    const connectBtn = document.getElementById('facebook-connect-btn');
    const importBtn = document.getElementById('facebook-import-btn');
    const disconnectBtn = document.getElementById('facebook-disconnect-btn');
    
    if (connectBtn) {
      connectBtn.onclick = connectFacebook;
    }
    
    if (importBtn) {
      importBtn.onclick = importFacebookContacts;
    }
    
    if (disconnectBtn) {
      disconnectBtn.onclick = disconnectFacebook;
    }
  }
  
  function connectFacebook() {
    updateFacebookStatus('connecting', 'Connecting');
    
    if (typeof FB === 'undefined') {
      showGlobalMessage('Facebook SDK not loaded. Please refresh the page.', 'error');
      updateFacebookStatus('disconnected', 'Disconnected');
      return;
    }
    
    FB.login(function(response) {
      if (response.authResponse) {
        facebookAccessToken = response.authResponse.accessToken;
        
        // Get user profile
        FB.api('/me', { fields: 'name,email,picture' }, function(profile) {
          facebookProfile = profile;
          updateFacebookStatus('connected', 'Connected');
          showFacebookProfile(profile);
        });
      } else {
        updateFacebookStatus('disconnected', 'Disconnected');
        showGlobalMessage('Facebook login was cancelled or failed.', 'error');
      }
    }, { scope: 'public_profile,email,user_friends' });
  }
  
  function showFacebookProfile(profile) {
    const profileDiv = document.getElementById('facebook-profile');
    const connectDiv = document.getElementById('facebook-connect');
    const connectedDiv = document.getElementById('facebook-connected');
    
    if (profileDiv && connectDiv && connectedDiv) {
      profileDiv.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
          <img src="${profile.picture?.data?.url || 'https://via.placeholder.com/50'}" 
               style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
          <div>
            <div style="font-weight: 600;">${profile.name}</div>
            <div style="font-size: 0.85rem; opacity: 0.8;">${profile.email || 'No email available'}</div>
          </div>
        </div>
      `;
      
      connectDiv.style.display = 'none';
      connectedDiv.style.display = 'block';
    }
  }
  
  async function importFacebookContacts() {
    if (backendStatus === 'offline') {
      showGlobalMessage('Service temporarily unavailable. Please wait for service to come back online.', 'error');
      return;
    }
    
    if (!facebookAccessToken) {
      showGlobalMessage('Please connect to Facebook first.', 'error');
      return;
    }
    
    const importBtn = document.getElementById('facebook-import-btn');
    const originalText = importBtn.textContent;
    importBtn.textContent = 'Importing...';
    importBtn.disabled = true;
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/facebook/import`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          accessToken: facebookAccessToken,
          userId: 'anonymous'
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        showGlobalMessage(`Successfully imported ${result.imported} new contacts and updated ${result.updated} existing contacts from Facebook!`, 'success');
      } else {
        throw new Error(result.error || 'Import failed');
      }
    } catch (error) {
      console.error('Facebook import error:', error);
      showGlobalMessage('Failed to import Facebook contacts. Please try again.', 'error');
    } finally {
      importBtn.textContent = originalText;
      importBtn.disabled = false;
    }
  }
  
  function disconnectFacebook() {
    if (typeof FB !== 'undefined') {
      FB.logout();
    }
    
    facebookAccessToken = null;
    facebookProfile = null;
    
    const connectDiv = document.getElementById('facebook-connect');
    const connectedDiv = document.getElementById('facebook-connected');
    
    if (connectDiv && connectedDiv) {
      connectDiv.style.display = 'block';
      connectedDiv.style.display = 'none';
    }
    
    updateFacebookStatus('disconnected', 'Disconnected');
    showGlobalMessage('Facebook account disconnected.', 'info');
  }
  
  function showGlobalMessage(message, type) {
    const messageDiv = document.getElementById('global-message');
    if (messageDiv) {
      const colors = {
        success: { bg: 'rgba(39, 174, 96, 0.1)', border: '#27ae60', text: '#27ae60' },
        error: { bg: 'rgba(231, 76, 60, 0.1)', border: '#e74c3c', text: '#e74c3c' },
        info: { bg: 'rgba(59, 130, 246, 0.1)', border: '#3b82f6', text: '#3b82f6' }
      };
      
      const color = colors[type] || colors.info;
      
      messageDiv.innerHTML = `
        <div style="
          background: ${color.bg};
          border: 1px solid ${color.border};
          color: ${color.text};
          padding: 1rem;
          border-radius: 8px;
          margin-top: 1rem;
          text-align: center;
          font-weight: 500;
        ">${message}</div>
      `;
      messageDiv.style.display = 'block';
      
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }
  }
  
  async function loadSampleContacts() {
    try {
      const response = await fetch(BACKEND_URL + '/api/search?q=test&limit=3');
      if (response.ok) {
        const data = await response.json();
        if (data && data.contacts && data.contacts.length > 0) {
          displaySampleContacts(data.contacts);
        }
      }
    } catch (error) {
      console.log('Sample contacts failed to load - widget still functional');
    }
  }
  
  function displaySampleContacts(contacts) {
    const resultsList = document.getElementById('results-list');
    const resultsContainer = document.getElementById('search-results');
    
    if (resultsList && resultsContainer) {
      resultsList.innerHTML = 
        '<div style="margin-bottom: 1rem; color: #00A86B; font-size: 0.9rem; text-align: center;"><strong>‚úÖ Connected to your contact database! Sample contacts:</strong></div>' +
        contacts.map(contact => {
          const details = [];
          if (contact.company) details.push(contact.company);
          if (contact.position || contact.jobTitle) details.push(contact.position || contact.jobTitle);
          if (contact.location) details.push(contact.location);
          if (contact.email) details.push(contact.email);
          
          return `
            <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem; border-left: 4px solid #00A86B;">
              <div style="font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem;">${contact.name || 'Unknown'}</div>
              <div style="font-size: 0.85rem; color: #666;">${details.join(' ‚Ä¢ ')}</div>
            </div>
          `;
        }).join('');
      
      resultsContainer.style.display = 'block';
    }
  }
  
  async function performSearch() {
    if (backendStatus === 'offline') {
      showGlobalMessage('Service temporarily unavailable. Please wait for service to come back online.', 'error');
      return;
    }
    
    const query = document.getElementById('search-input').value.trim();
    if (!query) return;
    
    const btn = document.getElementById('search-btn');
    btn.textContent = 'Searching...';
    btn.disabled = true;
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/search?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      const resultsList = document.getElementById('results-list');
      const resultsContainer = document.getElementById('search-results');
      
      if (data.contacts && data.contacts.length > 0) {
        resultsList.innerHTML = data.contacts.map(contact => `
          <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem; border-left: 4px solid #00A86B;">
            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem;">${contact.name || 'Unknown'}</div>
            <div style="font-size: 0.85rem; color: #666;">${[contact.company, contact.jobTitle, contact.location, contact.email].filter(Boolean).join(' ‚Ä¢ ')}</div>
          </div>
        `).join('');
      } else {
        resultsList.innerHTML = `<div style="text-align: center; color: #666; padding: 1rem;">No contacts found for "${query}"</div>`;
      }
      
      resultsContainer.style.display = 'block';
    } catch (error) {
      document.getElementById('results-list').innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 1rem;">Search failed. Please try again.</div>';
      document.getElementById('search-results').style.display = 'block';
    } finally {
      btn.textContent = 'Search Contacts';
      btn.disabled = false;
    }
  }
  
  // FIXED FILE UPLOAD - Uses standard field name
  function setupFileUpload() {
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    const uploadStatus = document.getElementById('upload-status');
    
    if (!uploadZone || !fileInput || !uploadStatus) {
      console.error('Upload elements not found');
      return;
    }
    
    // Click to upload
    uploadZone.onclick = () => {
      if (backendStatus === 'offline') {
        showGlobalMessage('Service offline. Please wait for service to come back online.', 'error');
        return;
      }
      fileInput.click();
    };
    
    // Drag and drop events
    uploadZone.ondragover = (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (backendStatus === 'offline') return;
      uploadZone.style.background = 'rgba(0, 168, 107, 0.15)';
      uploadZone.style.borderColor = 'rgba(0, 168, 107, 0.6)';
    };
    
    uploadZone.ondragleave = (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadZone.style.background = 'rgba(0, 168, 107, 0.05)';
      uploadZone.style.borderColor = 'rgba(0, 168, 107, 0.3)';
    };
    
    uploadZone.ondrop = (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      uploadZone.style.background = 'rgba(0, 168, 107, 0.05)';
      uploadZone.style.borderColor = 'rgba(0, 168, 107, 0.3)';
      
      if (backendStatus === 'offline') {
        showGlobalMessage('Service offline. Please wait for service to come back online.', 'error');
        return;
      }
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileUpload(files[0]);
      }
    };
    
    // File input change
    fileInput.onchange = (e) => {
      if (backendStatus === 'offline') {
        showGlobalMessage('Service offline. Please wait for service to come back online.', 'error');
        return;
      }
      
      const files = e.target.files;
      if (files.length > 0) {
        handleFileUpload(files[0]);
      }
    };
  }
  
  async function handleFileUpload(file) {
    const uploadStatus = document.getElementById('upload-status');
    
    if (!uploadStatus) {
      console.error('Upload status element not found');
      return;
    }
    
    // Validate file type
    if (!file.name.toLowerCase().endsWith('.csv')) {
      uploadStatus.innerHTML = '<div style="color: #e74c3c; padding: 1rem; text-align: center; background: rgba(231, 76, 60, 0.1); border-radius: 8px;">Please upload a CSV file from LinkedIn export.</div>';
      uploadStatus.style.display = 'block';
      return;
    }
    
    // Show uploading status
    uploadStatus.innerHTML = '<div style="color: #00A86B; padding: 1rem; text-align: center; background: rgba(0, 168, 107, 0.1); border-radius: 8px;">üì§ Uploading and processing your LinkedIn contacts...</div>';
    uploadStatus.style.display = 'block';
    
    try {
      // Create FormData with a simple field name that will work with upload.any()
      const formData = new FormData();
      formData.append('csvFile', file, file.name); // Simple field name
      
      console.log('Uploading file:', file.name, 'Size:', file.size);
      
      const response = await fetch(`${BACKEND_URL}/api/import/linkedin`, {
        method: 'POST',
        body: formData
        // Don't set Content-Type header - let browser set it
      });
      
      console.log('Response status:', response.status);
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Server error: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      console.log('Upload result:', result);
      
      if (result.success) {
        uploadStatus.innerHTML = `
          <div style="color: #00A86B; padding: 1.5rem; text-align: center; background: rgba(0, 168, 107, 0.1); border-radius: 8px;">
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">‚úÖ Import Successful!</div>
            <div style="font-size: 0.9rem; line-height: 1.4;">
              üìä Processed: <strong>${result.processed || 0}</strong> contacts<br>
              ‚ûï Added: <strong>${result.count || 0}</strong> new contacts<br>
              üîÑ Enhanced: <strong>${result.enhanced || 0}</strong> existing contacts<br>
              üìà Total in database: <strong>${result.totalContacts || 0}</strong> contacts
            </div>
            <div style="margin-top: 1rem; font-size: 0.85rem; opacity: 0.8;">
              ${result.message || 'Your LinkedIn contacts have been successfully imported!'}
            </div>
          </div>
        `;
      } else {
        throw new Error(result.message || 'Import failed');
      }
    } catch (error) {
      console.error('Upload error:', error);
      uploadStatus.innerHTML = `
        <div style="color: #e74c3c; padding: 1rem; text-align: center; background: rgba(231, 76, 60, 0.1); border-radius: 8px;">
          ‚ùå Upload failed: ${error.message}<br>
          <small style="opacity: 0.8; margin-top: 0.5rem; display: block;">Please check your file format and try again. LinkedIn exports should be in CSV format.</small>
        </div>
      `;
    }
    
    // Clear file input for re-upload
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
      fileInput.value = '';
    }
  }
});
</script>