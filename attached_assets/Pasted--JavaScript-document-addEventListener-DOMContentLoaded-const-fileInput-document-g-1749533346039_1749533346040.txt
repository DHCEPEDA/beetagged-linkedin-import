// JavaScript
document.addEventListener('DOMContentLoaded', () => {
  const fileInput = document.getElementById('file-input');
  const selectFileBtn = document.getElementById('select-file-btn');
  const uploadSection = document.getElementById('upload-section');
  const selectedFileEl = document.getElementById('selected-file');
  const uploadBtn = document.getElementById('upload-btn');
  const loadingEl = document.getElementById('loading');
  const errorMessageEl = document.getElementById('error-message');
  const importResultsEl = document.getElementById('import-results');
  const importSummaryEl = document.getElementById('import-summary');
  const contactsPreviewEl = document.getElementById('contacts-preview');
  const viewContactsBtn = document.getElementById('view-contacts-btn');
  const importMoreBtn = document.getElementById('import-more-btn');
  let selectedFile = null;

  function showError(msg) {
    errorMessageEl.textContent = msg;
    errorMessageEl.style.display = 'block';
  }

  function hideError() {
    errorMessageEl.style.display = 'none';
  }

  selectFileBtn.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      const file = e.target.files[0];
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showError('Please upload a CSV file exported from LinkedIn.');
        fileInput.value = '';
        selectedFile = null;
        selectedFileEl.style.display = 'none';
        uploadBtn.style.display = 'none';
        return;
      }
      selectedFile = file;
      selectedFileEl.textContent = `Selected: ${selectedFile.name}`;
      selectedFileEl.style.display = 'block';
      uploadBtn.style.display = 'inline-block';
      hideError();
    }
  });

  uploadSection.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadSection.classList.add('dragover');
  });

  uploadSection.addEventListener('dragleave', () => {
    uploadSection.classList.remove('dragover');
  });

  uploadSection.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadSection.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
      const file = e.dataTransfer.files[0];
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showError('Please upload a CSV file exported from LinkedIn.');
        return;
      }
      selectedFile = file;
      selectedFileEl.textContent = `Selected: ${selectedFile.name}`;
      selectedFileEl.style.display = 'block';
      uploadBtn.style.display = 'inline-block';
      hideError();
    }
  });

  uploadBtn.addEventListener('click', async () => {
    if (!selectedFile) {
      showError('Please select a file to upload.');
      return;
    }
    hideError();
    loadingEl.style.display = 'block';
    uploadBtn.disabled = true;
    const formData = new FormData();
    formData.append('file', selectedFile);
    try {
      const response = await fetch('/api/import/linkedin', {
        method: 'POST',
        body: formData
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.message || 'Failed to import LinkedIn connections.');
      loadingEl.style.display = 'none';
      importSummaryEl.textContent = data.message || `Successfully imported ${data.contacts?.length || 0} connections from LinkedIn.`;
      const previewContacts = (data.contacts || []).slice(0, 5);
      contactsPreviewEl.innerHTML = '';
      previewContacts.forEach(contact => {
        const contactEl = document.createElement('div');
        contactEl.className = 'contact-item';
        const tagsHTML = (contact.tags || []).map(tag =>
          `<div class="tag ${tag.type}">${tag.name}</div>`
        ).join('');
        contactEl.innerHTML = `
          <div class="contact-avatar">
            <img src="${contact.picture || '/images/default-avatar.png'}" alt="${contact.name}">
          </div>
          <div class="contact-details">
            <div class="contact-name">${contact.name}</div>
            <div class="contact-info">
              ${contact.company ? contact.company + ' Â· ' : ''}
              ${contact.title || ''}
            </div>
            <div class="contact-tags">
              ${tagsHTML}
            </div>
          </div>
        `;
        contactsPreviewEl.appendChild(contactEl);
      });
      localStorage.setItem('linkedinContacts', JSON.stringify(data.contacts || []));
      localStorage.setItem('authStatus', 'authenticated');
      localStorage.setItem('authProvider', 'linkedin_import');
      importResultsEl.style.display = 'block';
      uploadSection.style.display = 'none';
    } catch (error) {
      loadingEl.style.display = 'none';
      showError(error.message);
      uploadBtn.disabled = false;
    }
  });

  viewContactsBtn.addEventListener('click', () => {
    window.location.href = '/contact-manager-standalone.html';
  });

  importMoreBtn.addEventListener('click', () => {
    selectedFile = null;
    fileInput.value = '';
    selectedFileEl.style.display = 'none';
    uploadBtn.style.display = 'none';
    importResultsEl.style.display = 'none';
    uploadSection.style.display = 'block';
    uploadBtn.disabled = false;
    hideError();
  });
});