<!-- BeeTagged Complete Inline Widget - Copy this entire code into Code Injection Footer -->

<style>
.beetagged-widget {
  max-width: 800px;
  margin: 2rem auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

.beetagged-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1.5rem;
  text-align: center;
}

.beetagged-title {
  font-size: 1.8rem;
  font-weight: 700;
  margin: 0 0 0.5rem 0;
}

.beetagged-subtitle {
  opacity: 0.9;
  font-size: 1rem;
}

.beetagged-content {
  padding: 2rem;
}

.beetagged-section {
  margin-bottom: 2rem;
}

.section-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.beetagged-search-box {
  width: 100%;
  padding: 1rem;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 1rem;
  box-sizing: border-box;
  transition: border-color 0.2s;
}

.beetagged-search-box:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.beetagged-button {
  width: 100%;
  padding: 1rem;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s;
  margin-top: 1rem;
}

.beetagged-button:hover {
  background: #5a67d8;
}

.beetagged-button:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}

.beetagged-file-input {
  width: 100%;
  padding: 0.75rem;
  border: 2px dashed #d1d5db;
  border-radius: 8px;
  background: #f9fafb;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.beetagged-file-input:hover {
  border-color: #667eea;
  background: #f0f4ff;
}

.beetagged-status {
  padding: 1rem;
  border-radius: 8px;
  margin: 1rem 0;
  font-weight: 500;
  text-align: center;
}

.status-success {
  background: #d1fae5;
  color: #065f46;
  border: 1px solid #10b981;
}

.status-error {
  background: #fee2e2;
  color: #991b1b;
  border: 1px solid #ef4444;
}

.status-loading {
  background: #dbeafe;
  color: #1e40af;
  border: 1px solid #3b82f6;
}

.beetagged-results {
  background: #f9fafb;
  border-radius: 8px;
  padding: 1.5rem;
  min-height: 120px;
  max-height: 400px;
  overflow-y: auto;
}

.contact-item {
  background: white;
  padding: 1rem;
  border-radius: 6px;
  margin-bottom: 0.75rem;
  border: 1px solid #e5e7eb;
  cursor: pointer;
  transition: all 0.2s;
}

.contact-item:hover {
  border-color: #667eea;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.contact-name {
  font-weight: 600;
  color: #1f2937;
  font-size: 1.1rem;
  margin-bottom: 0.25rem;
}

.contact-details {
  color: #6b7280;
  font-size: 0.9rem;
  line-height: 1.4;
}

.contact-company {
  color: #374151;
  font-weight: 500;
}

.empty-state {
  text-align: center;
  color: #9ca3af;
  font-style: italic;
  padding: 2rem;
}
</style>

<div class="beetagged-widget">
  <div class="beetagged-header">
    <h2 class="beetagged-title">üêù BeeTagged</h2>
    <p class="beetagged-subtitle">Professional Contact Search & Management</p>
  </div>
  
  <div class="beetagged-content">
    <!-- Search Section -->
    <div class="beetagged-section">
      <h3 class="section-title">üîç Smart Contact Search</h3>
      <input type="text" 
             id="bt-search-input" 
             class="beetagged-search-box" 
             placeholder="Search contacts: 'engineers at Google', 'people in Austin', 'product managers'..."
             onkeypress="if(event.key==='Enter') btSearch()">
      <button class="beetagged-button" onclick="btSearch()" id="bt-search-btn">
        Search Contacts
      </button>
    </div>
    
    <!-- Upload Section -->
    <div class="beetagged-section">
      <h3 class="section-title">üìÅ Import LinkedIn Contacts</h3>
      <input type="file" 
             id="bt-file-input" 
             class="beetagged-file-input" 
             accept=".csv"
             onchange="btHandleFile(this)"
             style="display: none;">
      <div class="beetagged-file-input" onclick="document.getElementById('bt-file-input').click()">
        üìé Click to select LinkedIn CSV file
      </div>
      <button class="beetagged-button" onclick="btUpload()" id="bt-upload-btn" style="background: #10b981;">
        Import CSV Contacts
      </button>
    </div>
    
    <!-- Status -->
    <div id="bt-status" class="beetagged-status status-loading">
      Connecting to backend...
    </div>
    
    <!-- Results -->
    <div id="bt-results" class="beetagged-results">
      <div class="empty-state">Ready to search your professional network</div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  const BACKEND_URL = 'https://beetagged-app-53414697acd3.herokuapp.com';
  let contacts = [];
  let selectedFile = null;
  
  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    btInit();
  });
  
  // If DOM already loaded
  if (document.readyState !== 'loading') {
    btInit();
  }
  
  async function btInit() {
    try {
      await btCheckBackend();
      await btLoadContacts();
    } catch (error) {
      console.error('BeeTagged initialization failed:', error);
    }
  }
  
  async function btCheckBackend() {
    try {
      const response = await fetch(`${BACKEND_URL}/health`);
      const data = await response.json();
      
      if (data.status === 'healthy') {
        btUpdateStatus('success', `‚úÖ Connected - ${data.contacts} contacts available`);
        return true;
      } else {
        throw new Error('Backend unhealthy');
      }
    } catch (error) {
      btUpdateStatus('error', '‚ùå Backend connection failed');
      return false;
    }
  }
  
  async function btLoadContacts() {
    try {
      const response = await fetch(`${BACKEND_URL}/api/contacts`);
      const data = await response.json();
      
      contacts = data.contacts || [];
      btDisplayContacts(contacts.slice(0, 10)); // Show first 10
      btUpdateStatus('success', `Ready! ${contacts.length} contacts loaded`);
    } catch (error) {
      btUpdateStatus('error', 'Failed to load contacts');
      btShowResults([]);
    }
  }
  
  window.btSearch = async function() {
    const query = document.getElementById('bt-search-input').value.trim();
    const btn = document.getElementById('bt-search-btn');
    
    if (!query) {
      btDisplayContacts(contacts.slice(0, 10));
      return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Searching...';
    btUpdateStatus('loading', `Searching for: "${query}"`);
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/search/natural?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      if (data.results && data.results.length > 0) {
        btDisplayContacts(data.results);
        btUpdateStatus('success', `Found ${data.results.length} matches`);
      } else {
        // Fallback to local search
        const filtered = contacts.filter(contact => {
          const searchText = `${contact.name || ''} ${contact.company || ''} ${contact.position || ''}`.toLowerCase();
          return searchText.includes(query.toLowerCase());
        });
        
        btDisplayContacts(filtered);
        btUpdateStatus('success', `Found ${filtered.length} matches (local search)`);
      }
    } catch (error) {
      btUpdateStatus('error', 'Search failed: ' + error.message);
      btShowResults([]);
    } finally {
      btn.disabled = false;
      btn.textContent = 'Search Contacts';
    }
  };
  
  window.btHandleFile = function(input) {
    selectedFile = input.files[0];
    const label = input.parentElement;
    
    if (selectedFile) {
      label.innerHTML = `üìé Selected: ${selectedFile.name}`;
      label.style.borderColor = '#10b981';
      label.style.background = '#d1fae5';
    }
  };
  
  window.btUpload = async function() {
    if (!selectedFile) {
      btUpdateStatus('error', 'Please select a CSV file first');
      return;
    }
    
    const btn = document.getElementById('bt-upload-btn');
    btn.disabled = true;
    btn.textContent = 'Uploading...';
    btUpdateStatus('loading', 'Processing CSV file...');
    
    try {
      const formData = new FormData();
      formData.append('linkedinCsv', selectedFile);
      
      const response = await fetch(`${BACKEND_URL}/api/import/linkedin`, {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        btUpdateStatus('success', `‚úÖ Imported ${data.imported || 0} contacts. Duplicates: ${data.duplicates || 0}`);
        await btLoadContacts(); // Refresh contact list
      } else {
        btUpdateStatus('error', 'Upload failed: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      btUpdateStatus('error', 'Upload failed: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'Import CSV Contacts';
    }
  };
  
  function btUpdateStatus(type, message) {
    const status = document.getElementById('bt-status');
    status.className = `beetagged-status status-${type}`;
    status.textContent = message;
  }
  
  function btDisplayContacts(contactList) {
    const results = document.getElementById('bt-results');
    
    if (!contactList || contactList.length === 0) {
      results.innerHTML = '<div class="empty-state">No contacts found. Try a different search term.</div>';
      return;
    }
    
    const html = contactList.map(contact => `
      <div class="contact-item" onclick="btShowContactDetails('${contact._id || contact.id}')">
        <div class="contact-name">${contact.name || contact.basicInfo?.fullName || 'Unknown Contact'}</div>
        <div class="contact-details">
          <div class="contact-company">${contact.position || 'No position'} ${contact.company ? 'at ' + contact.company : ''}</div>
          ${contact.email ? `<div>üìß ${contact.email}</div>` : ''}
          ${contact.professional?.location || contact.personal?.location ? `<div>üìç ${contact.professional?.location || contact.personal?.location}</div>` : ''}
        </div>
      </div>
    `).join('');
    
    results.innerHTML = html;
  }
  
  window.btShowContactDetails = function(contactId) {
    const contact = contacts.find(c => (c._id || c.id) === contactId);
    if (contact) {
      alert(`Contact Details:\n\nName: ${contact.name || 'Unknown'}\nCompany: ${contact.company || 'Not specified'}\nEmail: ${contact.email || 'Not available'}\nPosition: ${contact.position || 'Not specified'}`);
    }
  };
  
  function btShowResults(resultList) {
    btDisplayContacts(resultList);
  }
  
})();
</script>