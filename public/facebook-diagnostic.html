<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facebook SDK Diagnostics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
    .card { margin-bottom: 20px; }
    .success { color: green; }
    .error { color: red; }
    .warning { color: orange; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1>Facebook SDK Diagnostics</h1>
    <p>This page will help diagnose issues with the Facebook JavaScript SDK integration.</p>
    
    <div class="card">
      <div class="card-header">
        Environment Information
      </div>
      <div class="card-body">
        <div id="envInfo">Loading...</div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        Facebook SDK Initialization
      </div>
      <div class="card-body">
        <div id="sdkStatus">Loading...</div>
        <button id="initButton" class="btn btn-primary mt-3">Initialize Facebook SDK</button>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        Login Status
      </div>
      <div class="card-body">
        <div id="loginStatus">Not checked yet</div>
        <button id="checkLoginButton" class="btn btn-primary mt-3" disabled>Check Login Status</button>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        Test Facebook Login
      </div>
      <div class="card-body">
        <div id="testLoginStatus">Not attempted yet</div>
        <button id="testLoginButton" class="btn btn-primary mt-3" disabled>Test Login</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        Domain Information
      </div>
      <div class="card-body">
        <div id="domainInfo">Loading...</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        Troubleshooting Help
      </div>
      <div class="card-body">
        <div id="troubleshootingTips"></div>
      </div>
    </div>
  </div>

  <script>
    // Display environment information
    document.getElementById('envInfo').innerHTML = `
      <p><strong>Current URL:</strong> ${window.location.href}</p>
      <p><strong>Protocol:</strong> ${window.location.protocol}</p>
      <p><strong>Host:</strong> ${window.location.host}</p>
      <p><strong>Pathname:</strong> ${window.location.pathname}</p>
      <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
    `;

    // Display domain information
    document.getElementById('domainInfo').innerHTML = `
      <p>Make sure the following domains are added to your Facebook App settings:</p>
      <ul>
        <li>App Domains: <code>${window.location.hostname}</code></li>
        <li>Website URL: <code>${window.location.origin}/</code></li>
        <li>Valid OAuth Redirect URIs: <code>${window.location.origin}/</code> and <code>${window.location.origin}/auth/facebook/callback</code></li>
        <li>Allowed Domains for the JavaScript SDK: <code>${window.location.hostname}</code></li>
      </ul>
    `;

    // Function to check if FB SDK is loaded
    function checkFBSDKLoaded() {
      return typeof FB !== 'undefined';
    }

    // Function to load the Facebook SDK
    function loadFacebookSDK(appId) {
      return new Promise((resolve, reject) => {
        if (checkFBSDKLoaded()) {
          resolve();
          return;
        }

        // Prepare the async init function
        window.fbAsyncInit = function() {
          try {
            FB.init({
              appId: appId,
              cookie: true,
              xfbml: true,
              version: 'v18.0'
            });
            
            document.getElementById('sdkStatus').innerHTML = `
              <p class="success">✅ Facebook SDK initialized successfully!</p>
              <p><strong>App ID:</strong> ${appId}</p>
              <p><strong>SDK Version:</strong> v18.0</p>
            `;
            
            document.getElementById('checkLoginButton').disabled = false;
            document.getElementById('testLoginButton').disabled = false;
            
            resolve();
          } catch (error) {
            document.getElementById('sdkStatus').innerHTML = `
              <p class="error">❌ Facebook SDK initialization failed!</p>
              <p><strong>Error:</strong> ${error.message}</p>
            `;
            reject(error);
          }
        };

        // Load the SDK
        (function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "https://connect.facebook.net/en_US/sdk.js";
          js.onerror = function() {
            document.getElementById('sdkStatus').innerHTML = `
              <p class="error">❌ Failed to load Facebook SDK!</p>
              <p>Check network connectivity and browser console for errors.</p>
            `;
            reject(new Error('Failed to load Facebook SDK'));
          };
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
      });
    }

    // Fetch app config from server to get the app ID
    async function fetchAppConfig() {
      try {
        const response = await fetch('/api/config');
        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }
        const config = await response.json();
        return config.socialNetworks.facebook.appId;
      } catch (error) {
        console.error('Error fetching app config:', error);
        return null;
      }
    }

    // Initialize with app ID from server or fallback
    document.getElementById('initButton').addEventListener('click', async function() {
      this.disabled = true;
      
      document.getElementById('sdkStatus').innerHTML = `<p>Fetching App ID from server...</p>`;
      
      let appId = await fetchAppConfig();
      
      if (!appId) {
        document.getElementById('sdkStatus').innerHTML = `
          <p class="warning">⚠️ Could not fetch App ID from server. Using hardcoded fallback.</p>
          <p>Enter your Facebook App ID:</p>
          <input type="text" id="appIdInput" class="form-control" value="1222790436230433">
          <button id="useAppIdButton" class="btn btn-secondary mt-2">Use this App ID</button>
        `;
        
        document.getElementById('useAppIdButton').addEventListener('click', function() {
          const manualAppId = document.getElementById('appIdInput').value.trim();
          if (manualAppId) {
            document.getElementById('sdkStatus').innerHTML = `<p>Loading Facebook SDK with App ID: ${manualAppId}...</p>`;
            loadFacebookSDK(manualAppId);
          }
        });
      } else {
        document.getElementById('sdkStatus').innerHTML = `<p>Loading Facebook SDK with App ID: ${appId}...</p>`;
        loadFacebookSDK(appId);
      }
    });

    // Check login status
    document.getElementById('checkLoginButton').addEventListener('click', function() {
      this.disabled = true;
      document.getElementById('loginStatus').innerHTML = `<p>Checking login status...</p>`;
      
      FB.getLoginStatus(function(response) {
        document.getElementById('checkLoginButton').disabled = false;
        
        if (response.status === 'connected') {
          document.getElementById('loginStatus').innerHTML = `
            <p class="success">✅ User is logged in and has authorized the app!</p>
            <pre>${JSON.stringify(response, null, 2)}</pre>
          `;
        } else if (response.status === 'authorization_expired') {
          document.getElementById('loginStatus').innerHTML = `
            <p class="warning">⚠️ User was logged in, but the authorization has expired.</p>
            <pre>${JSON.stringify(response, null, 2)}</pre>
          `;
        } else if (response.status === 'not_authorized') {
          document.getElementById('loginStatus').innerHTML = `
            <p class="warning">⚠️ User is logged into Facebook, but has not authorized the app.</p>
            <pre>${JSON.stringify(response, null, 2)}</pre>
          `;
        } else {
          // status is 'unknown'
          document.getElementById('loginStatus').innerHTML = `
            <p class="error">❓ User is not logged into Facebook or we can't tell.</p>
            <pre>${JSON.stringify(response, null, 2)}</pre>
          `;
        }
      });
    });

    // Test login
    document.getElementById('testLoginButton').addEventListener('click', function() {
      this.disabled = true;
      document.getElementById('testLoginStatus').innerHTML = `<p>Attempting login...</p>`;
      
      FB.login(function(response) {
        document.getElementById('testLoginButton').disabled = false;
        
        if (response.status === 'connected') {
          document.getElementById('testLoginStatus').innerHTML = `
            <p class="success">✅ Login successful!</p>
            <pre>${JSON.stringify(response, null, 2)}</pre>
          `;
          
          // Fetch user info
          FB.api('/me', {fields: 'name,email,picture'}, function(userData) {
            document.getElementById('testLoginStatus').innerHTML += `
              <p><strong>User Name:</strong> ${userData.name}</p>
              <p><strong>User Email:</strong> ${userData.email || 'Not provided'}</p>
              ${userData.picture ? `<p><strong>Picture:</strong> <img src="${userData.picture.data.url}" alt="Profile" style="border-radius: 50%;"></p>` : ''}
              <pre>${JSON.stringify(userData, null, 2)}</pre>
            `;
          });
        } else {
          document.getElementById('testLoginStatus').innerHTML = `
            <p class="error">❌ Login failed or was canceled by user.</p>
            <pre>${JSON.stringify(response, null, 2)}</pre>
          `;
        }
      }, {scope: 'public_profile,email'});
    });

    // Add troubleshooting tips
    document.getElementById('troubleshootingTips').innerHTML = `
      <h5>Common Issues and Solutions:</h5>
      <ol>
        <li>
          <strong>Unknown Host Domain Error</strong>
          <p>Make sure your domain is properly configured in your Facebook App settings. Add both the exact domain and wildcard patterns if needed.</p>
        </li>
        <li>
          <strong>App Not Live</strong>
          <p>For public access, your Facebook App needs to be in "Live" mode, not "Development" mode.</p>
        </li>
        <li>
          <strong>Incorrect App ID</strong>
          <p>Verify that you're using the correct App ID. Check both server configuration and client-side code.</p>
        </li>
        <li>
          <strong>Missing Permissions</strong>
          <p>Make sure your app requests the necessary permissions during login.</p>
        </li>
        <li>
          <strong>Cookie Issues</strong>
          <p>Facebook SDK requires cookies to work properly. Check browser settings and privacy tools.</p>
        </li>
        <li>
          <strong>HTTPS Required</strong>
          <p>Facebook requires HTTPS for most features. Make sure your site is served over HTTPS.</p>
        </li>
      </ol>
    `;
  </script>
</body>
</html>