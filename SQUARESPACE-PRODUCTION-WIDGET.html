<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeTagged Contact Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .search-pressed {
            transform: scale(1.02);
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .loading-animation {
            background: linear-gradient(90deg, #EBF4FF 25%, #DBEAFE 50%, #EBF4FF 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">BeeTagged</h1>
            <p class="text-xl text-gray-600">AI-Powered Professional Contact Search</p>
            <p class="text-gray-500 mt-2">Find exactly who you need in your network</p>
        </div>

        <!-- File Upload Section -->
        <div class="max-w-2xl mx-auto mb-8">
            <div class="bg-white rounded-lg p-6 shadow-sm border-2 border-dashed border-gray-300 hover:border-blue-400 transition-colors">
                <div class="text-center">
                    <svg class="h-12 w-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <h3 class="text-lg font-semibold mb-2">Import LinkedIn Contacts</h3>
                    <p class="text-gray-600 mb-4">Upload your LinkedIn connections CSV file to get started</p>
                    <p class="text-sm text-gray-500 mb-4">Required columns: First Name, Last Name, Company, Position</p>
                    
                    <input 
                        type="file" 
                        id="csvFileInput" 
                        accept=".csv" 
                        class="hidden"
                    />
                    <button 
                        id="uploadButton"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                    >
                        Choose CSV File
                    </button>
                    
                    <div id="uploadStatus" class="mt-4 hidden">
                        <div class="flex items-center justify-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                            <span class="text-blue-600">Uploading contacts...</span>
                        </div>
                    </div>
                    
                    <div id="uploadSuccess" class="mt-4 hidden">
                        <div class="flex items-center justify-center text-green-600">
                            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span id="uploadSuccessText">Contacts imported successfully!</span>
                        </div>
                    </div>

                    <div id="uploadError" class="mt-4 hidden">
                        <div class="text-red-600 text-sm">
                            <p id="uploadErrorText">Upload failed. Please check your CSV format.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="max-w-2xl mx-auto relative mb-8">
            <div class="relative">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Ask anything: 'engineers at Microsoft', 'contacts in Austin', 'who works at startups'..."
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg transition-all duration-200 hover:border-gray-400"
                />
            </div>
            <button
                id="searchButton"
                class="mt-3 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors"
            >
                Search
            </button>
        </div>

        <!-- Status Indicator -->
        <div id="statusIndicator" class="text-center mb-6">
            <div id="backendStatus" class="inline-flex items-center px-3 py-1 rounded-full text-sm">
                <div class="w-2 h-2 rounded-full mr-2"></div>
                <span>Connecting...</span>
            </div>
        </div>

        <!-- Results Section -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 id="resultsHeader" class="text-lg font-semibold text-gray-900">
                        Professional Contacts
                    </h3>
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                </div>
            </div>
            
            <div class="p-6">
                <div id="resultsContainer">
                    <div class="text-center py-8 text-gray-500">
                        <svg class="h-12 w-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        <p class="text-lg mb-2">Loading your contacts...</p>
                        <p>Search will be available once contacts are loaded</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-gray-500">
            <p>Powered by BeeTagged AI • Professional Network Intelligence</p>
            <p class="text-sm mt-1">$0.99/month • Advanced contact search and insights</p>
        </div>
    </div>

    <script>
        // Configuration - Heroku production backend with MongoDB Atlas
        const BACKEND_URL = 'https://beetagged-app-53414697acd3.herokuapp.com';
        
        // State
        let contacts = [];
        let searchResults = [];
        let isLoading = false;
        let backendConnected = false;

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsHeader = document.getElementById('resultsHeader');
        const backendStatus = document.getElementById('backendStatus');
        const csvFileInput = document.getElementById('csvFileInput');
        const uploadButton = document.getElementById('uploadButton');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadSuccess = document.getElementById('uploadSuccess');
        const uploadError = document.getElementById('uploadError');
        const uploadSuccessText = document.getElementById('uploadSuccessText');
        const uploadErrorText = document.getElementById('uploadErrorText');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkBackendHealth();
            loadContacts();
            
            // Event listeners
            searchButton.addEventListener('click', () => handleSearch(searchInput.value));
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    searchInput.classList.add('search-pressed');
                    setTimeout(() => searchInput.classList.remove('search-pressed'), 200);
                    handleSearch(searchInput.value);
                }
            });
            
            // File upload listeners
            uploadButton.addEventListener('click', () => csvFileInput.click());
            csvFileInput.addEventListener('change', handleFileUpload);
        });

        // Backend health check
        async function checkBackendHealth() {
            try {
                console.log('Checking backend health...');
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Health check response:', data);
                    backendConnected = true;
                    
                    // Handle different contact count formats
                    let contactCount = 0;
                    if (typeof data.contacts === 'number') {
                        contactCount = data.contacts;
                    } else if (data.contacts === 'checking...' || data.contacts === 'timeout') {
                        contactCount = 'checking...';
                    }
                    
                    updateStatus('connected', `Connected (${contactCount} contacts)`);
                } else {
                    console.error('Health check failed with status:', response.status);
                    updateStatus('error', 'Connection Error');
                }
            } catch (error) {
                console.error('Backend health check failed:', error);
                updateStatus('error', 'Backend Offline');
            }
        }

        // Update status indicator
        function updateStatus(status, text) {
            const statusDiv = backendStatus.querySelector('div');
            const statusText = backendStatus.querySelector('span');
            
            statusDiv.className = 'w-2 h-2 rounded-full mr-2';
            if (status === 'connected') {
                statusDiv.classList.add('bg-green-500');
                backendStatus.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800';
            } else {
                statusDiv.classList.add('bg-red-500');
                backendStatus.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-100 text-red-800';
            }
            
            statusText.textContent = text;
        }

        // Load all contacts
        async function loadContacts() {
            try {
                console.log('Loading contacts from:', `${BACKEND_URL}/api/contacts`);
                const response = await fetch(`${BACKEND_URL}/api/contacts`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                console.log('Contacts response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Raw contacts data:', data);
                    contacts = Array.isArray(data) ? data : [];
                    searchResults = contacts;
                    console.log('Loaded contacts:', contacts.length);
                    console.log('Sample contact:', contacts[0]);
                    displayResults();
                    
                    // Update health status with actual contact count
                    if (contacts.length > 0) {
                        updateStatus('connected', `Connected (${contacts.length} contacts)`);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load contacts - response not OK:', response.status, errorText);
                    contacts = [];
                    searchResults = [];
                    displayResults();
                }
            } catch (error) {
                console.error('Failed to load contacts:', error);
                contacts = [];
                searchResults = [];
                displayResults();
            }
        }

        // Handle search
        async function handleSearch(query) {
            if (!query.trim()) {
                searchResults = contacts;
                displayResults();
                return;
            }

            setLoading(true);
            try {
                const response = await fetch(`${BACKEND_URL}/api/search/natural?q=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    searchResults = result.results || [];
                } else {
                    // Fallback to local search
                    searchResults = contacts.filter(contact =>
                        contact.name?.toLowerCase().includes(query.toLowerCase()) ||
                        contact.company?.toLowerCase().includes(query.toLowerCase()) ||
                        contact.position?.toLowerCase().includes(query.toLowerCase())
                    );
                }
                displayResults();
            } catch (error) {
                console.error('Search failed:', error);
                // Fallback to local search
                searchResults = contacts.filter(contact =>
                    contact.name?.toLowerCase().includes(query.toLowerCase()) ||
                    contact.company?.toLowerCase().includes(query.toLowerCase()) ||
                    contact.position?.toLowerCase().includes(query.toLowerCase())
                );
                displayResults();
            }
            setLoading(false);
        }

        // Set loading state
        function setLoading(loading) {
            isLoading = loading;
            searchButton.disabled = loading;
            searchButton.textContent = loading ? 'Searching...' : 'Search';
            
            if (loading) {
                searchInput.classList.add('loading-animation');
            } else {
                searchInput.classList.remove('loading-animation');
            }
        }

        // Display search results
        function displayResults() {
            const query = searchInput.value.trim();
            resultsHeader.textContent = query 
                ? `Search Results (${searchResults.length})` 
                : `All Contacts (${contacts.length})`;

            if (searchResults.length === 0) {
                if (query) {
                    resultsContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <svg class="h-12 w-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <p class="text-lg mb-2">No contacts found</p>
                            <p>Try a different search query</p>
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <svg class="h-12 w-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            <p class="text-lg mb-2">Upload your LinkedIn CSV to get started</p>
                            <p>Then search your professional network with natural language</p>
                        </div>
                    `;
                }
                return;
            }

            const resultsHtml = searchResults.map(contact => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow mb-4">
                    <div class="flex items-start justify-between">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${contact.name || 'Unknown'}</h4>
                            ${contact.position && contact.company ? 
                                `<p class="text-gray-600">${contact.position} at ${contact.company}</p>` : 
                                contact.company ? `<p class="text-gray-600">${contact.company}</p>` :
                                contact.position ? `<p class="text-gray-600">${contact.position}</p>` : ''
                            }
                            ${contact.location ? 
                                `<p class="text-sm text-gray-500 mt-1">${contact.location}</p>` : ''
                            }
                            ${contact.email ? 
                                `<p class="text-sm text-blue-600 mt-1">${contact.email}</p>` : ''
                            }
                            ${contact.tags && contact.tags.length > 0 ? 
                                `<div class="flex flex-wrap gap-2 mt-2">
                                    ${contact.tags.map(tag => 
                                        `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${tag}</span>`
                                    ).join('')}
                                </div>` : ''
                            }
                        </div>
                    </div>
                </div>
            `).join('');

            resultsContainer.innerHTML = `<div class="space-y-4">${resultsHtml}</div>`;
        }

        // Handle file upload
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                uploadErrorText.textContent = 'Please select a CSV file.';
                uploadError.classList.remove('hidden');
                setTimeout(() => uploadError.classList.add('hidden'), 5000);
                return;
            }

            // Reset states
            uploadError.classList.add('hidden');
            uploadSuccess.classList.add('hidden');
            uploadStatus.classList.remove('hidden');
            uploadButton.disabled = true;
            uploadButton.textContent = 'Uploading...';

            try {
                const formData = new FormData();
                formData.append('linkedinCsv', file);

                const response = await fetch(`${BACKEND_URL}/api/import/linkedin`, {
                    method: 'POST',
                    body: formData
                });

                uploadStatus.classList.add('hidden');

                if (response.ok) {
                    const result = await response.json();
                    console.log('Upload result:', result);
                    
                    // Check if upload was actually successful
                    if (result.success && result.count > 0) {
                        uploadSuccessText.textContent = `${result.count} contacts imported successfully!`;
                        uploadSuccess.classList.remove('hidden');
                        
                        // Reload contacts to show new data
                        setTimeout(() => {
                            loadContacts();
                            checkBackendHealth();
                        }, 1000);
                        
                        // Hide success message after 5 seconds
                        setTimeout(() => {
                            uploadSuccess.classList.add('hidden');
                        }, 5000);
                    } else {
                        // Handle case where API says success=false or count=0
                        const message = result.message || 'No new contacts were imported';
                        throw new Error(message);
                    }
                    
                } else {
                    const errorData = await response.json().catch(() => ({ message: 'Upload failed' }));
                    throw new Error(errorData.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload failed:', error);
                uploadStatus.classList.add('hidden');
                
                let errorMessage = 'Upload failed. Please check your CSV format and try again.';
                if (error.message.includes('No valid contacts')) {
                    errorMessage = 'No valid contacts found. Required columns: First Name, Last Name, Company, Position.';
                } else if (error.message.includes('No new contacts imported')) {
                    errorMessage = 'All contacts in this file already exist in your database. Try a different CSV file.';
                } else if (error.message.includes('duplicates or errors')) {
                    errorMessage = 'These contacts already exist or there was a database error. Try different contacts.';
                }
                
                uploadErrorText.textContent = errorMessage;
                uploadError.classList.remove('hidden');
                setTimeout(() => uploadError.classList.add('hidden'), 8000);
            }

            // Reset button
            uploadButton.disabled = false;
            uploadButton.textContent = 'Choose CSV File';
            csvFileInput.value = '';
        }
    </script>
</body>
</html>