<!-- BeeTagged Complete Widget - Squarespace Footer Code Injection -->
<style>
    .beetagged-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .beetagged-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    .beetagged-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .beetagged-subtitle {
        font-size: 1.25rem;
        color: #64748b;
        margin-bottom: 0.5rem;
    }
    .beetagged-upload-section {
        max-width: 600px;
        margin: 0 auto 2rem;
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        border: 2px dashed #cbd5e1;
        transition: all 0.3s ease;
    }
    .beetagged-upload-section:hover {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .beetagged-upload-content {
        text-align: center;
    }
    .beetagged-upload-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 1rem;
        color: #94a3b8;
    }
    .beetagged-upload-button {
        background: #10b981;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 1rem;
    }
    .beetagged-upload-button:hover {
        background: #059669;
    }
    .beetagged-search-section {
        max-width: 600px;
        margin: 0 auto 2rem;
        position: relative;
    }
    .beetagged-search-input {
        width: 100%;
        padding: 16px 20px 16px 48px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1.1rem;
        transition: all 0.2s;
        box-sizing: border-box;
    }
    .beetagged-search-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .beetagged-search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        color: #94a3b8;
    }
    .beetagged-search-button {
        margin-top: 12px;
        width: 100%;
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 1rem;
    }
    .beetagged-search-button:hover {
        background: #2563eb;
    }
    .beetagged-status {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    .beetagged-status-badge {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }
    .beetagged-status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .beetagged-results {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    .beetagged-results-header {
        padding: 1rem 1.5rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .beetagged-results-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
    }
    .beetagged-results-content {
        padding: 1.5rem;
        max-height: 600px;
        overflow-y: auto;
    }
    .beetagged-contact {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        margin-bottom: 1rem;
        transition: all 0.2s;
        cursor: pointer;
    }
    .beetagged-contact:hover {
        background-color: #f8fafc;
        border-color: #3b82f6;
    }
    .beetagged-contact:last-child {
        margin-bottom: 0;
    }
    .beetagged-avatar {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        flex-shrink: 0;
        font-size: 1.1rem;
    }
    .beetagged-contact-info {
        flex: 1;
        min-width: 0;
    }
    .beetagged-contact-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 4px;
    }
    .beetagged-contact-details {
        color: #64748b;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    .beetagged-empty {
        text-align: center;
        padding: 3rem 2rem;
        color: #94a3b8;
    }
    .beetagged-empty-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 1rem;
        color: #cbd5e1;
    }
    .beetagged-message {
        margin-top: 1rem;
        padding: 12px 16px;
        border-radius: 6px;
        text-align: center;
        font-weight: 500;
    }
    .beetagged-message.hidden {
        display: none;
    }
    .beetagged-message.success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }
    .beetagged-message.error {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    .beetagged-message.loading {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
    }
    .beetagged-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #e5e7eb;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: beetagged-spin 1s linear infinite;
        margin-right: 8px;
    }
    @keyframes beetagged-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .beetagged-footer {
        text-align: center;
        margin-top: 2rem;
        color: #94a3b8;
        font-size: 0.9rem;
    }
</style>

<div class="beetagged-container" id="beetaggedApp">
    <!-- Header -->
    <div class="beetagged-header">
        <h1 class="beetagged-title">BeeTagged</h1>
        <p class="beetagged-subtitle">AI-Powered Professional Contact Search</p>
        <p style="color: #94a3b8;">Find exactly who you need in your network</p>
    </div>

    <!-- File Upload Section -->
    <div class="beetagged-upload-section">
        <div class="beetagged-upload-content">
            <svg class="beetagged-upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <h3 style="margin: 0 0 8px 0; color: #1e293b;">Import LinkedIn Contacts</h3>
            <p style="margin: 0 0 16px 0; color: #64748b;">Upload your LinkedIn connections CSV file to get started</p>
            
            <input type="file" id="beetaggedFileInput" accept=".csv" style="display: none;" />
            <button id="beetaggedUploadBtn" class="beetagged-upload-button">Choose CSV File</button>
            
            <div id="beetaggedUploadMessage" class="beetagged-message loading hidden">
                <span class="beetagged-spinner"></span>
                Uploading contacts...
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="beetagged-search-section">
        <div style="position: relative;">
            <svg class="beetagged-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input
                type="text"
                id="beetaggedSearchInput"
                placeholder="Ask anything: 'engineers at Microsoft', 'contacts in Austin', 'who works at startups'..."
                class="beetagged-search-input"
            />
        </div>
        <button id="beetaggedSearchBtn" class="beetagged-search-button">Search Contacts</button>
    </div>

    <!-- Status -->
    <div class="beetagged-status">
        <div id="beetaggedStatusBadge" class="beetagged-status-badge">
            <div class="beetagged-status-dot"></div>
            <span>Connecting to backend...</span>
        </div>
    </div>

    <!-- Results -->
    <div class="beetagged-results">
        <div class="beetagged-results-header">
            <h3 id="beetaggedResultsTitle" class="beetagged-results-title">Professional Contacts</h3>
            <svg style="width: 20px; height: 20px; color: #94a3b8;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
            </svg>
        </div>
        
        <div class="beetagged-results-content">
            <div id="beetaggedContactsList">
                <div class="beetagged-empty">
                    <svg class="beetagged-empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                    <p style="font-size: 1.1rem; margin: 0 0 8px 0; color: #64748b;">Loading your contacts...</p>
                    <p style="margin: 0;">Search will be available once contacts are loaded</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="beetagged-footer">
        <p>Powered by BeeTagged AI • Professional Network Intelligence</p>
        <p>$0.99/month • Advanced contact search and insights</p>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Configuration - Updated backend URL with CORS fixes
    const BACKEND_URL = 'https://beetagged-app-53414697acd3.herokuapp.com';
    
    // State management
    let appState = {
        contacts: [],
        searchResults: [],
        isLoading: false,
        backendConnected: false
    };

    // DOM element cache
    const elements = {
        searchInput: document.getElementById('beetaggedSearchInput'),
        searchButton: document.getElementById('beetaggedSearchBtn'),
        contactsList: document.getElementById('beetaggedContactsList'),
        resultsTitle: document.getElementById('beetaggedResultsTitle'),
        statusBadge: document.getElementById('beetaggedStatusBadge'),
        fileInput: document.getElementById('beetaggedFileInput'),
        uploadBtn: document.getElementById('beetaggedUploadBtn'),
        uploadMessage: document.getElementById('beetaggedUploadMessage')
    };

    // Initialize the application
    function initializeBeeTagged() {
        console.log('BeeTagged: Initializing application...');
        
        // Set up event listeners
        setupEventListeners();
        
        // Check backend connection
        checkBackendHealth();
        
        // Load existing contacts
        loadContacts();
    }

    // Set up all event listeners
    function setupEventListeners() {
        if (elements.searchButton) {
            elements.searchButton.addEventListener('click', handleSearch);
        }
        
        if (elements.searchInput) {
            elements.searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
        }
        
        if (elements.uploadBtn) {
            elements.uploadBtn.addEventListener('click', function() {
                elements.fileInput.click();
            });
        }
        
        if (elements.fileInput) {
            elements.fileInput.addEventListener('change', handleFileUpload);
        }
    }

    // Check backend health and connectivity
    async function checkBackendHealth() {
        try {
            updateStatus('connecting', 'Connecting to backend...');
            
            const response = await fetch(BACKEND_URL + '/health', {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('BeeTagged: Backend health check successful', data);
                
                appState.backendConnected = true;
                const contactCount = data.contacts || 0;
                updateStatus('connected', `Connected (${contactCount} contacts)`);
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('BeeTagged: Backend health check failed', error);
            updateStatus('error', 'Connection failed');
        }
    }

    // Update status indicator
    function updateStatus(status, message) {
        if (!elements.statusBadge) return;
        
        const dot = elements.statusBadge.querySelector('.beetagged-status-dot');
        const text = elements.statusBadge.querySelector('span');
        
        if (!dot || !text) return;
        
        // Reset classes
        elements.statusBadge.className = 'beetagged-status-badge';
        
        switch (status) {
            case 'connected':
                dot.style.backgroundColor = '#10b981';
                elements.statusBadge.style.backgroundColor = '#dcfce7';
                elements.statusBadge.style.color = '#166534';
                break;
            case 'error':
                dot.style.backgroundColor = '#ef4444';
                elements.statusBadge.style.backgroundColor = '#fef2f2';
                elements.statusBadge.style.color = '#991b1b';
                break;
            default:
                dot.style.backgroundColor = '#f59e0b';
                elements.statusBadge.style.backgroundColor = '#fef3c7';
                elements.statusBadge.style.color = '#92400e';
        }
        
        text.textContent = message;
    }

    // Load contacts from backend
    async function loadContacts() {
        try {
            console.log('BeeTagged: Loading contacts...');
            
            const response = await fetch(BACKEND_URL + '/api/contacts', {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                const contacts = await response.json();
                console.log(`BeeTagged: Loaded ${contacts.length} contacts`);
                
                appState.contacts = contacts || [];
                appState.searchResults = appState.contacts;
                displayContacts();
            } else {
                console.error('BeeTagged: Failed to load contacts', response.status);
                displayEmptyState();
            }
        } catch (error) {
            console.error('BeeTagged: Contact loading error', error);
            displayEmptyState();
        }
    }

    // Handle search functionality
    async function handleSearch() {
        const query = elements.searchInput ? elements.searchInput.value.trim() : '';
        
        if (!query) {
            appState.searchResults = appState.contacts;
            displayContacts();
            return;
        }

        setLoadingState(true);
        
        try {
            // Try AI-powered search first
            const response = await fetch(BACKEND_URL + '/api/search/natural?q=' + encodeURIComponent(query), {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                appState.searchResults = result.results || [];
                console.log(`BeeTagged: Search found ${appState.searchResults.length} results`);
            } else {
                // Fallback to local search
                performLocalSearch(query);
            }
        } catch (error) {
            console.error('BeeTagged: Search error', error);
            // Fallback to local search
            performLocalSearch(query);
        }
        
        setLoadingState(false);
        displayContacts();
    }

    // Perform local search as fallback
    function performLocalSearch(query) {
        const lowerQuery = query.toLowerCase();
        appState.searchResults = appState.contacts.filter(contact => {
            return (contact.name && contact.name.toLowerCase().includes(lowerQuery)) ||
                   (contact.company && contact.company.toLowerCase().includes(lowerQuery)) ||
                   (contact.position && contact.position.toLowerCase().includes(lowerQuery)) ||
                   (contact.email && contact.email.toLowerCase().includes(lowerQuery));
        });
        console.log(`BeeTagged: Local search found ${appState.searchResults.length} results`);
    }

    // Set loading state for search
    function setLoadingState(loading) {
        appState.isLoading = loading;
        
        if (elements.searchButton) {
            elements.searchButton.disabled = loading;
            elements.searchButton.textContent = loading ? 'Searching...' : 'Search Contacts';
        }
    }

    // Display contacts in the UI
    function displayContacts() {
        const query = elements.searchInput ? elements.searchInput.value.trim() : '';
        const count = appState.searchResults.length;
        
        // Update title
        if (elements.resultsTitle) {
            elements.resultsTitle.textContent = query 
                ? `Search Results (${count})` 
                : `All Contacts (${appState.contacts.length})`;
        }

        if (!elements.contactsList) return;

        // Handle empty state
        if (count === 0) {
            if (query) {
                elements.contactsList.innerHTML = createEmptySearchHtml();
            } else {
                elements.contactsList.innerHTML = createEmptyStateHtml();
            }
            return;
        }

        // Display contacts
        const contactsHtml = appState.searchResults.map(createContactHtml).join('');
        elements.contactsList.innerHTML = contactsHtml;
    }

    // Create HTML for individual contact
    function createContactHtml(contact) {
        const name = contact.name || 'Unknown';
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        const position = contact.position || 'No position';
        const company = contact.company || 'No company';
        const email = contact.email || '';
        
        return `
            <div class="beetagged-contact">
                <div class="beetagged-avatar">${initials}</div>
                <div class="beetagged-contact-info">
                    <div class="beetagged-contact-name">${escapeHtml(name)}</div>
                    <div class="beetagged-contact-details">
                        ${escapeHtml(position)}<br>
                        ${escapeHtml(company)}${email ? '<br>' + escapeHtml(email) : ''}
                    </div>
                </div>
            </div>
        `;
    }

    // Create empty state HTML
    function createEmptyStateHtml() {
        return `
            <div class="beetagged-empty">
                <svg class="beetagged-empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                </svg>
                <p style="font-size: 1.1rem; margin: 0 0 8px 0;">No contacts yet</p>
                <p style="margin: 0;">Upload a LinkedIn CSV file to get started</p>
            </div>
        `;
    }

    // Create empty search results HTML
    function createEmptySearchHtml() {
        return `
            <div class="beetagged-empty">
                <svg class="beetagged-empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p style="font-size: 1.1rem; margin: 0 0 8px 0;">No contacts found</p>
                <p style="margin: 0;">Try a different search term or upload more contacts</p>
            </div>
        `;
    }

    // Display empty state
    function displayEmptyState() {
        if (elements.contactsList) {
            elements.contactsList.innerHTML = createEmptyStateHtml();
        }
    }

    // Handle file upload
    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        showMessage('loading', 'Uploading contacts...');

        try {
            const formData = new FormData();
            formData.append('linkedinCsv', file);

            const response = await fetch(BACKEND_URL + '/api/import/linkedin', {
                method: 'POST',
                mode: 'cors',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    showMessage('success', result.message || `Successfully imported ${result.count} contacts!`);
                    
                    // Reload contacts and update status
                    setTimeout(() => {
                        loadContacts();
                        checkBackendHealth();
                    }, 1000);
                } else {
                    showMessage('error', result.message || 'Upload failed. Please check your CSV format.');
                }
            } else {
                const errorResult = await response.json().catch(() => ({}));
                showMessage('error', errorResult.message || 'Upload failed. Please check your CSV format.');
            }
        } catch (error) {
            console.error('BeeTagged: Upload error', error);
            showMessage('error', 'Upload failed. Please check your connection and try again.');
        }

        // Clear file input
        if (elements.fileInput) {
            elements.fileInput.value = '';
        }
    }

    // Show upload messages
    function showMessage(type, text) {
        if (!elements.uploadMessage) return;
        
        // Reset classes
        elements.uploadMessage.className = `beetagged-message ${type}`;
        elements.uploadMessage.classList.remove('hidden');
        
        if (type === 'loading') {
            elements.uploadMessage.innerHTML = `<span class="beetagged-spinner"></span>${text}`;
        } else {
            elements.uploadMessage.textContent = text;
        }
        
        // Auto-hide non-loading messages
        if (type !== 'loading') {
            setTimeout(() => {
                elements.uploadMessage.classList.add('hidden');
            }, 5000);
        }
    }

    // Utility function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeBeeTagged);
    } else {
        initializeBeeTagged();
    }

    console.log('BeeTagged: Widget script loaded successfully');
})();
</script>