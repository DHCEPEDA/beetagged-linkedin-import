<!-- BeeTagged Production Widget for Squarespace Header Injection -->
<!-- Copy this code into: Settings > Advanced > Code Injection > HEADER -->

<div id="beetagged-widget-container"></div>

<script>
window.addEventListener('load', function() {
  const BACKEND_URL = 'https://beetagged-app-53414697acd3.herokuapp.com';
  
  const widgetHTML = `
    <div style="
      position: relative;
      width: 100%;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
      box-sizing: border-box;
    ">
      <div style="
        max-width: 800px;
        width: 100%;
        padding: 2rem;
        background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 100%);
        border-radius: 16px;
        color: #2c3e50;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        margin: auto;
      ">
        <div style="text-align: center; margin-bottom: 2rem;">
          <h1 style="font-size: 2.5rem; font-weight: 700; margin: 0 0 0.5rem 0; background: linear-gradient(45deg, #00A86B, #2ecc71); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üêù BeeTagged</h1>
          <p style="font-size: 1.1rem; opacity: 0.9; margin: 0;">AI-Powered Contact Intelligence & Search</p>
        </div>
        
        <div style="display: flex; background: rgba(255,255,255,0.3); border-radius: 12px; padding: 4px; margin-bottom: 2rem;">
          <button id="search-tab" style="flex: 1; padding: 12px 16px; border: none; background: rgba(255,255,255,0.8); color: #2c3e50; cursor: pointer; border-radius: 8px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">Search Contacts</button>
          <button id="import-tab" style="flex: 1; padding: 12px 16px; border: none; background: transparent; color: #2c3e50; cursor: pointer; border-radius: 8px; font-weight: 500;">Import LinkedIn</button>
        </div>
        
        <!-- Search Tab Content -->
        <div id="search-content" style="display: block;">
          <div style="background: rgba(255,255,255,0.8); padding: 2rem; border-radius: 12px; margin-bottom: 1rem;">
            <input type="text" id="search-input" placeholder="Search your contacts naturally: 'engineers at Google'" style="
              width: 100%;
              padding: 12px 16px;
              border: 2px solid rgba(0, 168, 107, 0.2);
              border-radius: 8px;
              font-size: 1rem;
              margin-bottom: 1rem;
              background: white;
              color: #333;
              box-sizing: border-box;
            ">
            
            <button id="search-btn" style="
              width: 100%;
              padding: 12px 24px;
              border: none;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              background: linear-gradient(45deg, #00A86B, #2ecc71);
              color: white;
              transition: all 0.3s ease;
            ">Search Contacts</button>
            
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 1rem; justify-content: center;">
              <span class="example-tag" data-query="engineers at Google" style="background: rgba(0, 168, 107, 0.1); padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(0, 168, 107, 0.3); color: #00A86B;">Engineers at Google</span>
              <span class="example-tag" data-query="people in San Francisco" style="background: rgba(0, 168, 107, 0.1); padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(0, 168, 107, 0.3); color: #00A86B;">San Francisco</span>
              <span class="example-tag" data-query="marketing directors" style="background: rgba(0, 168, 107, 0.1); padding: 6px 12px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(0, 168, 107, 0.3); color: #00A86B;">Marketing Directors</span>
            </div>
          </div>
          
          <div id="search-results" style="
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
            display: none;
          ">
            <h3 style="margin: 0 0 1rem 0; text-align: center; color: #2c3e50;">Search Results</h3>
            <div id="results-list"></div>
          </div>
        </div>
        
        <!-- Import Tab Content -->
        <div id="import-content" style="display: none;">
          <div style="background: rgba(255,255,255,0.8); padding: 2rem; border-radius: 12px;">
            <h3 style="margin: 0 0 1rem 0; color: #2c3e50;">üíº LinkedIn Import</h3>
            <div id="upload-zone" style="
              border: 2px dashed rgba(0, 168, 107, 0.3);
              border-radius: 12px;
              padding: 2rem;
              text-align: center;
              cursor: pointer;
              background: rgba(0, 168, 107, 0.05);
              margin-bottom: 1rem;
            ">
              <h4 style="margin: 0 0 1rem 0; color: #2c3e50;">üìÅ Upload LinkedIn CSV</h4>
              <p style="margin: 0 0 0.5rem 0; color: #2c3e50;">Export your LinkedIn connections and upload the CSV file here</p>
              <p style="font-size: 0.9rem; opacity: 0.8; margin: 0; color: #2c3e50;">Drag & drop or click to select</p>
              <input type="file" id="file-input" accept=".csv" style="display: none;">
            </div>
            
            <div id="upload-status" style="display: none;"></div>
            
            <div style="margin-top: 1rem;">
              <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">üìã How to export from LinkedIn:</h4>
              <ol style="font-size: 0.9rem; color: #2c3e50; padding-left: 1.2rem; margin: 0;">
                <li>Go to LinkedIn Settings & Privacy</li>
                <li>Click "Data Privacy" ‚Üí "Get a copy of your data"</li>
                <li>Select "Connections" and download</li>
                <li>Upload the CSV file here</li>
              </ol>
            </div>
          </div>
        </div>
        
        <div id="global-message" style="display: none;"></div>
      </div>
    </div>
  `;
  
  // Insert widget into container
  const container = document.getElementById('beetagged-widget-container');
  if (container) {
    container.innerHTML = widgetHTML;
    setupWidget();
  }
  
  function setupWidget() {
    // Tab switching
    const searchTab = document.getElementById('search-tab');
    const importTab = document.getElementById('import-tab');
    const searchContent = document.getElementById('search-content');
    const importContent = document.getElementById('import-content');
    
    if (searchTab && importTab && searchContent && importContent) {
      searchTab.onclick = function() {
        searchTab.style.background = 'rgba(255,255,255,0.8)';
        searchTab.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        importTab.style.background = 'transparent';
        importTab.style.boxShadow = 'none';
        searchContent.style.display = 'block';
        importContent.style.display = 'none';
      };
      
      importTab.onclick = function() {
        importTab.style.background = 'rgba(255,255,255,0.8)';
        importTab.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        searchTab.style.background = 'transparent';
        searchTab.style.boxShadow = 'none';
        importContent.style.display = 'block';
        searchContent.style.display = 'none';
      };
    }
    
    // Search functionality
    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');
    
    if (searchBtn) {
      searchBtn.onclick = performSearch;
    }
    
    if (searchInput) {
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      });
    }
    
    // Example tags
    const exampleTags = document.querySelectorAll('.example-tag');
    exampleTags.forEach(tag => {
      tag.onclick = function() {
        const query = this.getAttribute('data-query');
        if (searchInput) {
          searchInput.value = query;
          performSearch();
        }
      };
      
      // Hover effects
      tag.onmouseover = function() { this.style.background = 'rgba(0, 168, 107, 0.2)'; };
      tag.onmouseout = function() { this.style.background = 'rgba(0, 168, 107, 0.1)'; };
    });
    
    // File upload
    setupFileUpload();
    
    // Load sample contacts
    loadSampleContacts();
  }
  
  async function loadSampleContacts() {
    try {
      const response = await fetch(BACKEND_URL + '/api/search?q=test&limit=3');
      if (response.ok) {
        const data = await response.json();
        if (data && data.contacts && data.contacts.length > 0) {
          displaySampleContacts(data.contacts);
        }
      }
    } catch (error) {
      console.log('Sample contacts failed to load - widget still functional');
    }
  }
  
  function displaySampleContacts(contacts) {
    const resultsList = document.getElementById('results-list');
    const resultsContainer = document.getElementById('search-results');
    
    if (resultsList && resultsContainer) {
      resultsList.innerHTML = 
        '<div style="margin-bottom: 1rem; color: #00A86B; font-size: 0.9rem; text-align: center;"><strong>‚úÖ Connected to your contact database! Sample contacts:</strong></div>' +
        contacts.map(contact => {
          const details = [];
          if (contact.company) details.push(contact.company);
          if (contact.position || contact.jobTitle) details.push(contact.position || contact.jobTitle);
          if (contact.location) details.push(contact.location);
          if (contact.email) details.push(contact.email);
          
          return `
            <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem; border-left: 4px solid #00A86B;">
              <div style="font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem;">${contact.name || 'Unknown'}</div>
              <div style="font-size: 0.85rem; color: #666;">${details.join(' ‚Ä¢ ')}</div>
            </div>
          `;
        }).join('');
      
      resultsContainer.style.display = 'block';
    }
  }
  
  async function performSearch() {
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const resultsList = document.getElementById('results-list');
    const resultsContainer = document.getElementById('search-results');
    
    if (!searchInput || !searchBtn || !resultsList || !resultsContainer) return;
    
    const query = searchInput.value.trim();
    if (!query) return;
    
    searchBtn.textContent = 'Searching...';
    searchBtn.disabled = true;
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/search?q=${encodeURIComponent(query)}`);
      
      if (response.ok) {
        const data = await response.json();
        
        if (data.contacts && data.contacts.length > 0) {
          resultsList.innerHTML = data.contacts.map(contact => {
            const details = [];
            if (contact.company) details.push(contact.company);
            if (contact.position || contact.jobTitle) details.push(contact.position || contact.jobTitle);
            if (contact.location) details.push(contact.location);
            if (contact.email) details.push(contact.email);
            
            return `
              <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem; border-left: 4px solid #00A86B;">
                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem;">${contact.name || 'Unknown'}</div>
                <div style="font-size: 0.85rem; color: #666;">${details.join(' ‚Ä¢ ')}</div>
              </div>
            `;
          }).join('');
          
          resultsContainer.style.display = 'block';
        } else {
          resultsList.innerHTML = `<div style="text-align: center; color: #666; padding: 1rem;">No contacts found for "${query}". Try a different search term.</div>`;
          resultsContainer.style.display = 'block';
        }
      } else {
        throw new Error('Search failed');
      }
    } catch (error) {
      resultsList.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 1rem;">Search temporarily unavailable. Please try again later.</div>';
      resultsContainer.style.display = 'block';
    } finally {
      searchBtn.textContent = 'Search Contacts';
      searchBtn.disabled = false;
    }
  }
  
  function setupFileUpload() {
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    const uploadStatus = document.getElementById('upload-status');
    
    if (!uploadZone || !fileInput || !uploadStatus) return;
    
    uploadZone.onclick = () => fileInput.click();
    
    uploadZone.ondragover = (e) => {
      e.preventDefault();
      uploadZone.style.background = 'rgba(0, 168, 107, 0.1)';
    };
    
    uploadZone.ondragleave = () => {
      uploadZone.style.background = 'rgba(0, 168, 107, 0.05)';
    };
    
    uploadZone.ondrop = (e) => {
      e.preventDefault();
      uploadZone.style.background = 'rgba(0, 168, 107, 0.05)';
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileUpload(files[0]);
      }
    };
    
    fileInput.onchange = (e) => {
      if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
      }
    };
  }
  
  async function handleFileUpload(file) {
    const uploadStatus = document.getElementById('upload-status');
    
    if (!file.name.endsWith('.csv')) {
      uploadStatus.innerHTML = '<div style="color: #e74c3c; padding: 1rem; text-align: center;">Please upload a CSV file.</div>';
      uploadStatus.style.display = 'block';
      return;
    }
    
    uploadStatus.innerHTML = '<div style="color: #00A86B; padding: 1rem; text-align: center;">Uploading and processing...</div>';
    uploadStatus.style.display = 'block';
    
    const formData = new FormData();
    formData.append('contacts', file);
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/import/linkedin`, {
        method: 'POST',
        body: formData
      });
      
      if (response.ok) {
        const result = await response.json();
        uploadStatus.innerHTML = `
          <div style="color: #00A86B; padding: 1rem; text-align: center;">
            <strong>‚úÖ Import successful!</strong><br>
            Processed: ${result.total || 0} contacts<br>
            Added: ${result.inserted || 0} new contacts<br>
            Updated: ${result.updated || 0} existing contacts
          </div>
        `;
      } else {
        throw new Error('Upload failed');
      }
    } catch (error) {
      uploadStatus.innerHTML = '<div style="color: #e74c3c; padding: 1rem; text-align: center;">Upload failed. Please try again.</div>';
    }
  }
});
</script>