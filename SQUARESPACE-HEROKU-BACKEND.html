<style>
.beetagged-widget {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 100%);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    color: #2c3e50;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    position: relative;
}

.status-indicator {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #27ae60;
    animation: pulse 2s infinite;
}

.status-indicator.disconnected {
    background: #e74c3c;
}

.status-indicator.connecting {
    background: #f39c12;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.beetagged-header {
    text-align: center;
    margin-bottom: 2rem;
}

.beetagged-header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(45deg, #00A86B, #2ecc71);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.beetagged-search-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
}

.beetagged-search-input {
    flex: 1;
    padding: 1rem;
    border: 2px solid rgba(0, 168, 107, 0.2);
    border-radius: 12px;
    font-size: 1rem;
    background: rgba(255, 255, 255, 0.9);
    transition: all 0.3s ease;
}

.beetagged-search-input:focus {
    outline: none;
    border-color: #00A86B;
    box-shadow: 0 0 0 3px rgba(0, 168, 107, 0.1);
}

.beetagged-search-btn {
    padding: 1rem 2rem;
    background: linear-gradient(45deg, #00A86B, #2ecc71);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.beetagged-search-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 168, 107, 0.3);
}

.beetagged-search-btn:disabled {
    background: #95a5a6;
    cursor: not-allowed;
    transform: none;
}

.beetagged-results {
    margin-top: 2rem;
}

.beetagged-contact {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    border-left: 4px solid #00A86B;
}

.beetagged-contact:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.beetagged-contact-name {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.beetagged-contact-details {
    color: #7f8c8d;
    line-height: 1.5;
}

.beetagged-status {
    text-align: center;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-weight: 500;
}

.status-online {
    background: rgba(39, 174, 96, 0.1);
    color: #27ae60;
    border: 1px solid rgba(39, 174, 96, 0.2);
}

.status-offline {
    background: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
    border: 1px solid rgba(231, 76, 60, 0.2);
}

.status-connecting {
    background: rgba(243, 156, 18, 0.1);
    color: #f39c12;
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0, 168, 107, 0.3);
    border-radius: 50%;
    border-top-color: #00A86B;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.sample-contacts {
    margin-top: 1rem;
}

.sample-contact {
    background: rgba(255, 255, 255, 0.7);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-left: 3px solid #3498db;
    cursor: pointer;
}

.backend-selector {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    text-align: center;
    font-size: 0.9rem;
}

.backend-url {
    font-family: monospace;
    background: rgba(0, 0, 0, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
}
</style>

<div class="beetagged-widget">
    <div class="status-indicator" id="statusIndicator"></div>
    
    <div class="beetagged-header">
        <h1>üêù BeeTagged</h1>
        <p>Professional Contact Search</p>
    </div>

    <div class="backend-selector">
        <strong>Backend:</strong> <span class="backend-url" id="currentBackend">Detecting...</span>
    </div>

    <div id="serviceStatus" class="beetagged-status status-connecting">
        <span class="loading"></span> Connecting to service...
    </div>

    <div class="beetagged-search-container">
        <input 
            type="text" 
            id="searchInput"
            class="beetagged-search-input"
            placeholder="Search contacts naturally (e.g., 'engineers at Google')"
            disabled
        >
        <button id="searchBtn" class="beetagged-search-btn" disabled>
            Search
        </button>
    </div>

    <div id="searchResults" class="beetagged-results"></div>
</div>

<script>
// Multiple backend URLs to try (replace YOUR_HEROKU_APP with your actual app name)
const BACKEND_URLS = [
    'YOUR_HEROKU_APP.herokuapp.com',  // Replace with your actual Heroku app name
    'https://d49cd8c1-1139-4a7e-96a2-5d125f417ecd.id.replit.app'  // Replit fallback
];

let BACKEND_URL = null;
let isOnline = false;
let searchCache = new Map();

function updateStatus(status, message) {
    const indicator = document.getElementById('statusIndicator');
    const statusDiv = document.getElementById('serviceStatus');
    
    indicator.className = `status-indicator ${status}`;
    statusDiv.className = `beetagged-status status-${status}`;
    statusDiv.innerHTML = message;
    
    isOnline = (status === 'online');
    document.getElementById('searchInput').disabled = !isOnline;
    document.getElementById('searchBtn').disabled = !isOnline;
}

async function findWorkingBackend() {
    document.getElementById('currentBackend').textContent = 'Testing backends...';
    
    for (const url of BACKEND_URLS) {
        try {
            const fullUrl = url.startsWith('http') ? url : `https://${url}`;
            console.log(`Testing backend: ${fullUrl}`);
            
            const response = await fetch(`${fullUrl}/`, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
                cache: 'no-cache',
                signal: AbortSignal.timeout(5000) // 5 second timeout
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.status && (data.status.includes('BeeTagged') || data.status.includes('running'))) {
                    BACKEND_URL = fullUrl;
                    document.getElementById('currentBackend').textContent = fullUrl.replace('https://', '');
                    console.log(`Found working backend: ${BACKEND_URL}`);
                    return true;
                }
            }
        } catch (error) {
            console.log(`Backend ${url} failed:`, error.message);
        }
    }
    
    document.getElementById('currentBackend').textContent = 'No working backend found';
    return false;
}

async function checkServiceHealth() {
    try {
        updateStatus('connecting', '<span class="loading"></span> Finding backend...');
        
        if (!BACKEND_URL) {
            const found = await findWorkingBackend();
            if (!found) {
                updateStatus('offline', '‚ùå No backend available - Deploy your Heroku app first');
                showSetupMessage();
                return false;
            }
        }
        
        updateStatus('connecting', '<span class="loading"></span> Testing connection...');
        
        const response = await fetch(`${BACKEND_URL}/`, {
            method: 'GET',
            headers: { 'Accept': 'application/json' },
            cache: 'no-cache'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.status && (data.status.includes('BeeTagged') || data.status.includes('running'))) {
                updateStatus('online', '‚úÖ Service online - Ready to search contacts');
                showSampleContacts();
                return true;
            }
        }
        
        throw new Error(`HTTP ${response.status}`);
    } catch (error) {
        updateStatus('offline', '‚ùå Service temporarily unavailable');
        showOfflineMessage();
        return false;
    }
}

async function searchContacts(query) {
    if (!isOnline || !query.trim() || !BACKEND_URL) return;
    
    if (searchCache.has(query)) {
        displayResults(searchCache.get(query), query);
        return;
    }
    
    try {
        document.getElementById('searchBtn').innerHTML = '<span class="loading"></span> Searching...';
        document.getElementById('searchBtn').disabled = true;
        
        const response = await fetch(`${BACKEND_URL}/api/search?q=${encodeURIComponent(query)}`);
        
        if (response.ok) {
            const data = await response.json();
            searchCache.set(query, data);
            displayResults(data, query);
        } else {
            throw new Error(`Search failed: ${response.status}`);
        }
    } catch (error) {
        document.getElementById('searchResults').innerHTML = '<div class="beetagged-status status-offline">‚ùå Search temporarily unavailable. Please try again later.</div>';
    } finally {
        document.getElementById('searchBtn').innerHTML = 'Search';
        document.getElementById('searchBtn').disabled = !isOnline;
    }
}

function displayResults(data, query) {
    const results = document.getElementById('searchResults');
    
    if (!data.contacts || data.contacts.length === 0) {
        results.innerHTML = `<div class="beetagged-status status-offline">No contacts found for "${query}". Try a different search term.</div>`;
        return;
    }

    const contactsHtml = data.contacts.map(contact => `
        <div class="beetagged-contact">
            <div class="beetagged-contact-name">${contact.name || 'Unknown'}</div>
            <div class="beetagged-contact-details">
                ${contact.company ? `<strong>Company:</strong> ${contact.company}<br>` : ''}
                ${contact.jobTitle ? `<strong>Title:</strong> ${contact.jobTitle}<br>` : ''}
                ${contact.location ? `<strong>Location:</strong> ${contact.location}<br>` : ''}
                ${contact.email ? `<strong>Email:</strong> ${contact.email}` : ''}
            </div>
        </div>
    `).join('');

    results.innerHTML = `<h3>Found ${data.contacts.length} contact${data.contacts.length !== 1 ? 's' : ''} for "${query}"</h3>${contactsHtml}`;
}

function showSampleContacts() {
    document.getElementById('searchResults').innerHTML = `
        <div class="sample-contacts">
            <h3>üí° Try searching for:</h3>
            <div class="sample-contact" onclick="performSearch('engineers at Google')">
                <strong>engineers at Google</strong> - Find technical professionals
            </div>
            <div class="sample-contact" onclick="performSearch('people in San Francisco')">
                <strong>people in San Francisco</strong> - Location-based search
            </div>
            <div class="sample-contact" onclick="performSearch('marketing directors')">
                <strong>marketing directors</strong> - Search by job title
            </div>
        </div>
    `;
}

function showSetupMessage() {
    document.getElementById('searchResults').innerHTML = `
        <div class="beetagged-status status-offline">
            üöÄ <strong>Setup Required</strong><br>
            Deploy your Heroku app first, then update the BACKEND_URLS in this code with your Heroku app name.<br>
            <small>Format: your-app-name.herokuapp.com</small>
        </div>
    `;
}

function showOfflineMessage() {
    document.getElementById('searchResults').innerHTML = '<div class="beetagged-status status-offline">üîå Service temporarily offline. Features limited until connection is restored.<br><small>This usually resolves automatically within a few minutes.</small></div>';
}

function performSearch(query) {
    document.getElementById('searchInput').value = query;
    searchContacts(query);
}

document.addEventListener('DOMContentLoaded', () => {
    checkServiceHealth();
    setInterval(checkServiceHealth, 60000);
    
    document.getElementById('searchBtn').addEventListener('click', () => {
        const query = document.getElementById('searchInput').value.trim();
        if (query) searchContacts(query);
    });
    
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !document.getElementById('searchBtn').disabled) {
            const query = document.getElementById('searchInput').value.trim();
            if (query) searchContacts(query);
        }
    });
});
</script>